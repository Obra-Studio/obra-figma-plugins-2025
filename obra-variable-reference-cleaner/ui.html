
<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 16px;
      background: white;
      font-size: 12px;
      line-height: 1.5;
    }
    
    .header {
      margin-bottom: 20px;
    }
    
    .title {
      font-size: 14px;
      font-weight: 600;
      color: #000;
      margin-bottom: 8px;
    }
    
    .description {
      color: #666;
      margin-bottom: 20px;
    }
    
    .button {
      background: #18A0FB;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      width: 100%;
      margin-bottom: 16px;
    }
    
    .button:hover {
      background: #0F8CE5;
    }
    
    .button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .status {
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 12px;
    }
    
    .status.info {
      background: #E3F2FD;
      color: #1976D2;
      border: 1px solid #BBDEFB;
    }
    
    .status.success {
      background: #E8F5E8;
      color: #2E7D32;
      border: 1px solid #C8E6C9;
    }
    
    .results {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #E1E1E1;
      border-radius: 6px;
      padding: 12px;
    }
    
    .node-result {
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #F0F0F0;
    }
    
    .node-result:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }
    
    .node-name {
      font-weight: 600;
      color: #000;
      margin-bottom: 4px;
    }
    
    .node-type {
      font-size: 11px;
      color: #666;
      margin-bottom: 8px;
    }
    
    .change {
      font-size: 11px;
      margin-bottom: 4px;
      padding: 4px 8px;
      background: #F8F9FA;
      border-radius: 4px;
    }
    
    .change-property {
      font-weight: 500;
      color: #333;
    }
    
    .change-from {
      color: #D32F2F;
    }
    
    .change-to {
      color: #388E3C;
    }
    
    .close-button {
      background: #666;
      margin-top: 8px;
    }
    
    .close-button:hover {
      background: #555;
    }
    
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="title">Variable Reference Cleaner</div>
    <div class="description">
      This plugin finds layers with variables that reference other variables (semantic → primitive) 
      and updates them to reference the primitive variable directly.
    </div>
  </div>

  <button id="processBtn" class="button">Process All Layers</button>
  
  <div id="status" class="hidden"></div>
  <div id="results" class="hidden"></div>
  
  <button id="closeBtn" class="button close-button">Close Plugin</button>

  <script>
    var processBtn = document.getElementById('processBtn');
    var closeBtn = document.getElementById('closeBtn');
    var status = document.getElementById('status');
    var results = document.getElementById('results');
    
    processBtn.onclick = function() {
      processBtn.disabled = true;
      processBtn.textContent = 'Processing...';
      
      status.className = 'status info';
      status.textContent = 'Scanning layers for variable references...';
      status.classList.remove('hidden');
      
      results.classList.add('hidden');
      
      parent.postMessage({ pluginMessage: { type: 'process' } }, '*');
    };
    
    closeBtn.onclick = function() {
      parent.postMessage({ pluginMessage: { type: 'close' } }, '*');
    };
    
    window.onmessage = function(event) {
      var msg = event.data.pluginMessage;
      
      if (msg.type === 'progress') {
        status.className = 'status info';
        status.textContent = msg.message;
        status.classList.remove('hidden');
      } else if (msg.type === 'complete') {
        processBtn.disabled = false;
        processBtn.textContent = 'Process All Layers';
        
        if (msg.results.length === 0) {
          status.className = 'status success';
          status.textContent = 'No variable references found that need updating.';
        } else {
          status.className = 'status success';
          status.textContent = 'Found and updated ' + msg.results.length + ' layer(s) with external variable references.';
          
          // Display results
          var html = '<div class="results">';
          for (var i = 0; i < msg.results.length; i++) {
            var result = msg.results[i];
            html += '<div class="node-result">';
            html += '<div class="node-name">' + escapeHtml(result.nodeName) + '</div>';
            html += '<div class="node-type">' + result.nodeType + '</div>';
            
            for (var j = 0; j < result.changes.length; j++) {
              var change = result.changes[j];
              html += '<div class="change">';
              html += '<span class="change-property">' + change.property + ':</span> ';
              html += '<span class="change-from">' + escapeHtml(change.from) + '</span> → ';
              html += '<span class="change-to">' + escapeHtml(change.to) + '</span>';
              html += '</div>';
            }
            
            html += '</div>';
          }
          html += '</div>';
          
          results.innerHTML = html;
          results.classList.remove('hidden');
        }
      }
    };
    
    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>