<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Variable Collection Merger</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #1e1e1e;
      --bg-secondary: #2d2d2d;
      --bg-tertiary: #3d3d3d;
      --bg-hover: #4d4d4d;
      --text-primary: #ffffff;
      --text-secondary: #b3b3b3;
      --text-muted: #808080;
      --accent: #0d99ff;
      --accent-hover: #0b85e0;
      --accent-subtle: rgba(13, 153, 255, 0.15);
      --success: #14ae5c;
      --success-subtle: rgba(20, 174, 92, 0.15);
      --warning: #f2994a;
      --warning-subtle: rgba(242, 153, 74, 0.15);
      --error: #f24822;
      --error-subtle: rgba(242, 72, 34, 0.15);
      --border: #404040;
      --border-light: #505050;
      --radius-sm: 4px;
      --radius-md: 6px;
      --radius-lg: 8px;
    }

    /* Figma light theme overrides */
    .figma-light {
      --bg-primary: #ffffff;
      --bg-secondary: #f5f5f5;
      --bg-tertiary: #e8e8e8;
      --bg-hover: #d9d9d9;
      --text-primary: #1e1e1e;
      --text-secondary: #5c5c5c;
      --text-muted: #8c8c8c;
      --border: #e0e0e0;
      --border-light: #c7c7c7;
      --accent-subtle: rgba(13, 153, 255, 0.1);
      --success-subtle: rgba(20, 174, 92, 0.1);
      --warning-subtle: rgba(242, 153, 74, 0.1);
      --error-subtle: rgba(242, 72, 34, 0.1);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 12px;
      line-height: 1.5;
      color: var(--text-primary);
      background: var(--bg-primary);
      padding: 16px;
      min-height: 100vh;
    }

    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 20px;
      background: var(--bg-secondary);
      padding: 4px;
      border-radius: var(--radius-md);
    }

    .tab {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 12px;
      background: transparent;
      border: none;
      border-radius: var(--radius-sm);
      color: var(--text-muted);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .tab:hover {
      color: var(--text-secondary);
      background: var(--bg-tertiary);
    }

    .tab.active {
      background: var(--accent);
      color: white;
    }

    .tab svg {
      flex-shrink: 0;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .tab-description {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .tab-description svg {
      flex-shrink: 0;
      opacity: 0.7;
    }

    .section {
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .section-title .badge {
      background: var(--bg-tertiary);
      color: var(--text-muted);
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 500;
    }

    .section-hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .collection-list {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .collection-item {
      background: transparent;
      border: none;
      border-bottom: 1px solid var(--border);
      padding: 12px 14px;
      cursor: pointer;
      transition: background 0.15s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .collection-item:last-child {
      border-bottom: none;
    }

    .collection-item:hover {
      background: var(--bg-hover);
    }

    .collection-item.selected {
      background: var(--accent-subtle);
    }

    .collection-item.target {
      background: var(--success-subtle);
    }

    .collection-item.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    .collection-radio,
    .collection-checkbox {
      width: 16px;
      height: 16px;
      border: 2px solid var(--border-light);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.15s ease;
    }

    .collection-checkbox {
      border-radius: var(--radius-sm);
    }

    .collection-item.target .collection-radio {
      border-color: var(--success);
      background: var(--success);
    }

    .collection-item.target .collection-radio::after {
      content: '';
      width: 6px;
      height: 6px;
      background: white;
      border-radius: 50%;
    }

    .collection-item.selected .collection-checkbox {
      border-color: var(--accent);
      background: var(--accent);
    }

    .collection-item.selected .collection-checkbox::after {
      content: '';
      width: 8px;
      height: 8px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
      background-size: contain;
    }

    .collection-info {
      flex: 1;
      min-width: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .collection-name {
      font-weight: 500;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
      min-width: 0;
    }

    .collection-badges {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
    }

    .collection-badge {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 500;
      white-space: nowrap;
    }

    .collection-count {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 500;
      flex-shrink: 0;
    }

    .divider {
      height: 1px;
      background: var(--border);
      margin: 20px 0;
    }

    .option-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-bottom: none;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .option-row:first-of-type {
      border-radius: var(--radius-md) var(--radius-md) 0 0;
    }

    .option-row:last-of-type {
      border-radius: 0 0 var(--radius-md) var(--radius-md);
      border-bottom: 1px solid var(--border);
    }

    .option-row:only-of-type {
      border-radius: var(--radius-md);
      border-bottom: 1px solid var(--border);
    }

    .option-row:not(:last-of-type) {
      border-bottom: 1px solid var(--border);
    }

    .option-row:hover {
      background: var(--bg-hover);
    }

    .option-row input[type="checkbox"] {
      display: none;
    }

    .custom-checkbox {
      width: 16px;
      height: 16px;
      border: 2px solid var(--border-light);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.15s ease;
    }

    .option-row input[type="checkbox"]:checked + .custom-checkbox {
      border-color: var(--accent);
      background: var(--accent);
    }

    .option-row input[type="checkbox"]:checked + .custom-checkbox::after {
      content: '';
      width: 8px;
      height: 8px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
      background-size: contain;
    }

    .option-label {
      flex: 1;
    }

    .option-label strong {
      display: block;
      font-weight: 500;
    }

    .option-label span {
      font-size: 10px;
      color: var(--text-muted);
    }

    .actions {
      display: flex;
      gap: 8px;
      margin-top: 20px;
    }

    .btn {
      flex: 1;
      padding: 10px 16px;
      border: none;
      border-radius: var(--radius-md);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn svg {
      width: 14px;
      height: 14px;
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background: var(--bg-hover);
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    .btn-primary:disabled {
      background: var(--bg-tertiary);
      color: var(--text-muted);
      cursor: not-allowed;
    }

    .status-message {
      padding: 10px 12px;
      border-radius: var(--radius-md);
      font-size: 11px;
      margin-bottom: 16px;
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }

    .status-message svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
      margin-top: 1px;
    }

    .status-message.success {
      background: var(--success-subtle);
      color: var(--success);
    }

    .status-message.error {
      background: var(--error-subtle);
      color: var(--error);
    }

    .status-message.warning {
      background: var(--warning-subtle);
      color: var(--warning);
    }

    .status-message.info {
      background: var(--accent-subtle);
      color: var(--accent);
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .empty-state svg {
      width: 48px;
      height: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--bg-tertiary);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 12px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .preview-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 12px;
      margin-top: 16px;
    }

    .preview-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .preview-title svg {
      width: 12px;
      height: 12px;
    }

    .preview-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .stat-item {
      text-align: center;
      padding: 8px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
    }

    .stat-value {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .stat-label {
      font-size: 10px;
      color: var(--text-muted);
      font-weight: 500;
    }

    .hidden {
      display: none !important;
    }

    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      margin-bottom: 10px;
      flex-wrap: wrap;
      font-size: 11px;
    }

    .breadcrumb-item {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: color 0.15s ease;
    }

    .breadcrumb-item:hover {
      color: var(--accent);
    }

    .breadcrumb-item.current {
      color: var(--text-primary);
      font-weight: 500;
      cursor: default;
    }

    .breadcrumb-separator {
      color: var(--text-muted);
    }

    .group-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .group-item.has-children::after {
      content: '';
      margin-left: auto;
      width: 16px;
      height: 16px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23808080' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='9 18 15 12 9 6'%3E%3C/polyline%3E%3C/svg%3E");
      background-size: contain;
      opacity: 0.5;
    }

    .tree-view {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .tree-item {
      display: flex;
      flex-direction: column;
      border-bottom: 1px solid var(--border);
    }

    .tree-item:last-child {
      border-bottom: none;
    }

    .tree-item-content {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: transparent;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .tree-item-content:hover {
      background: var(--bg-hover);
    }

    .tree-item-content.selected {
      background: var(--accent-subtle);
    }

    .tree-item-expand {
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      transition: transform 0.15s ease;
    }

    .tree-item-expand svg {
      width: 12px;
      height: 12px;
      color: var(--text-muted);
    }

    .tree-item-expand.expanded {
      transform: rotate(90deg);
    }

    .tree-item-expand.empty {
      opacity: 0;
      pointer-events: none;
    }

    .tree-item-radio {
      width: 16px;
      height: 16px;
      border: 2px solid var(--border-light);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.15s ease;
    }

    .tree-item-content.selected .tree-item-radio {
      border-color: var(--accent);
      background: var(--accent);
    }

    .tree-item-content.selected .tree-item-radio::after {
      content: '';
      width: 6px;
      height: 6px;
      background: white;
      border-radius: 50%;
    }

    .tree-item-info {
      flex: 1;
      min-width: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tree-item-name {
      font-size: 12px;
      color: var(--text-primary);
    }

    .tree-item-count {
      font-size: 10px;
      color: var(--text-muted);
      background: var(--bg-tertiary);
      padding: 2px 6px;
      border-radius: 10px;
    }

    .tree-item-children {
      margin-left: 24px;
      display: none;
      flex-direction: column;
      border-top: 1px solid var(--border);
    }

    .tree-item-children.expanded {
      display: flex;
    }

    .tree-item-children .tree-item {
      border-bottom: 1px solid var(--border);
    }

    .tree-item-children .tree-item:last-child {
      border-bottom: none;
    }

    /* Collection with expandable groups */
    .collection-with-groups {
      display: flex;
      flex-direction: column;
    }

    .collection-with-groups:last-child > .collection-header {
      border-bottom: none;
    }

    .collection-with-groups:last-child > .collection-groups-container {
      border-bottom: none;
    }

    .collection-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      cursor: pointer;
      transition: background 0.15s ease;
      background: transparent;
      border-bottom: 1px solid var(--border);
    }

    /* Hide header border when groups are expanded */
    .collection-groups-container.expanded ~ .collection-header,
    .collection-with-groups:has(.collection-groups-container.expanded) > .collection-header {
      border-bottom: 1px solid var(--border);
    }

    .collection-header:hover {
      background: var(--bg-hover);
    }

    .collection-expand-icon {
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: transform 0.15s ease;
    }

    .collection-expand-icon svg {
      width: 12px;
      height: 12px;
      color: var(--text-muted);
    }

    .collection-expand-icon.expanded {
      transform: rotate(90deg);
    }

    .collection-groups-container {
      display: none;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border);
    }

    .collection-groups-container.expanded {
      display: block;
    }

    .collection-groups-container .tree-view {
      border: none;
      border-radius: 0;
      background: transparent;
    }

    .collection-groups-container .tree-item:first-child {
      border-top: 1px solid var(--border);
    }

    .step-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
    }

    .step {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .step.active {
      color: var(--accent);
    }

    .step.completed {
      color: var(--success);
    }

    .step-number {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 10px;
    }

    .step.active .step-number {
      background: var(--accent);
      color: white;
    }

    .step.completed .step-number {
      background: var(--success);
      color: white;
    }

    .step-connector {
      flex: 1;
      height: 2px;
      background: var(--bg-tertiary);
    }

    .step-connector.completed {
      background: var(--success);
    }

    .mode-warning {
      background: var(--warning-subtle);
      border: 1px solid var(--warning);
      border-radius: var(--radius-md);
      padding: 12px;
      margin-top: 16px;
      display: flex;
      gap: 10px;
    }

    .mode-warning-icon {
      flex-shrink: 0;
      color: var(--warning);
    }

    .mode-warning-icon svg {
      width: 18px;
      height: 18px;
    }

    .mode-warning-content {
      flex: 1;
    }

    .mode-warning-content strong {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--warning);
      margin-bottom: 4px;
    }

    .mode-warning-content p {
      font-size: 11px;
      color: var(--text-secondary);
      margin: 0;
      line-height: 1.4;
    }

    .mode-warning-option {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(242, 153, 74, 0.3);
      cursor: pointer;
      font-size: 11px;
      color: var(--text-primary);
    }

    .mode-warning-option input[type="checkbox"] {
      display: none;
    }

    .mode-warning-option .custom-checkbox.small {
      width: 14px;
      height: 14px;
      border: 2px solid var(--warning);
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.15s ease;
    }

    .mode-warning-option input[type="checkbox"]:checked + .custom-checkbox.small {
      background: var(--warning);
    }

    .mode-warning-option input[type="checkbox"]:checked + .custom-checkbox.small::after {
      content: '';
      width: 8px;
      height: 8px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
      background-size: contain;
    }

    .mode-badge {
      display: inline-block;
      background: var(--bg-tertiary);
      padding: 1px 5px;
      border-radius: 3px;
      font-weight: 500;
      font-size: 10px;
      margin: 0 2px;
    }

    .mode-badge.warning {
      background: var(--warning-subtle);
      color: var(--warning);
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .text-input {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 12px;
      font-family: inherit;
      outline: none;
      transition: all 0.15s ease;
    }

    .text-input:hover {
      border-color: var(--border-light);
    }

    .text-input:focus {
      border-color: var(--accent);
      background: var(--bg-tertiary);
    }

    .text-input::placeholder {
      color: var(--text-muted);
    }

    .inline-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 11px;
      color: var(--text-secondary);
    }

    .inline-checkbox input[type="checkbox"] {
      display: none;
    }

    .inline-checkbox .custom-checkbox.small {
      width: 14px;
      height: 14px;
      border: 2px solid var(--border-light);
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.15s ease;
    }

    .inline-checkbox input[type="checkbox"]:checked + .custom-checkbox.small {
      border-color: var(--accent);
      background: var(--accent);
    }

    .inline-checkbox input[type="checkbox"]:checked + .custom-checkbox.small::after {
      content: '';
      width: 8px;
      height: 8px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
      background-size: contain;
    }

    .no-groups-message {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 16px 14px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      color: var(--text-muted);
      font-size: 11px;
      line-height: 1.4;
      text-align: center;
      justify-content: center;
    }

    .no-groups-message svg {
      flex-shrink: 0;
    }

    .single-collection-warning {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 16px;
      background: var(--warning-subtle);
      border: 1px solid var(--warning);
      border-radius: var(--radius-md);
      margin-bottom: 20px;
    }

    .single-collection-warning svg {
      width: 20px;
      height: 20px;
      color: var(--warning);
      flex-shrink: 0;
      margin-top: 1px;
    }

    .single-collection-warning strong {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--warning);
      margin-bottom: 4px;
    }

    .single-collection-warning p {
      font-size: 11px;
      color: var(--text-secondary);
      margin: 0;
      line-height: 1.4;
    }

    .info-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--accent);
      color: white;
      text-decoration: none;
      border-radius: var(--radius-md);
      font-size: 12px;
      font-weight: 500;
      transition: opacity 0.2s;
    }

    .info-link:hover {
      opacity: 0.85;
    }

    .accordion {
      margin-bottom: 16px;
    }

    .accordion-trigger {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: 11px;
      color: var(--text-secondary);
      transition: all 0.15s ease;
      width: 100%;
      text-align: left;
    }

    .accordion-trigger:hover {
      border-color: var(--border-light);
      background: var(--bg-tertiary);
    }

    .accordion-trigger svg {
      flex-shrink: 0;
      transition: transform 0.2s ease;
    }

    .accordion-trigger.expanded svg {
      transform: rotate(90deg);
    }

    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .accordion-content.expanded {
      max-height: 500px;
    }

    .accordion-content-inner {
      padding: 12px 12px 0 12px;
      font-size: 11px;
      color: var(--text-secondary);
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" id="tab-merge" onclick="switchTab('merge')">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M8 6l4-4 4 4"></path>
        <path d="M12 2v10.3a4 4 0 0 1-1.172 2.872L4 22"></path>
        <path d="m20 22-5-5"></path>
      </svg>
      Merge
    </button>
    <button class="tab" id="tab-split" onclick="switchTab('split')">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M16 3h5v5"></path>
        <path d="M8 3H3v5"></path>
        <path d="M12 22v-8.3a4 4 0 0 0-1.172-2.872L3 3"></path>
        <path d="m15 9 6-6"></path>
      </svg>
      Split
    </button>
    <button class="tab" id="tab-move" onclick="switchTab('move')">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M18 8L22 12L18 16"></path>
        <path d="M2 12H22"></path>
      </svg>
      Move
    </button>
    <button class="tab" id="tab-info" onclick="switchTab('info')">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="16" x2="12" y2="12"></line>
        <line x1="12" y1="8" x2="12.01" y2="8"></line>
      </svg>
      Info
    </button>
  </div>

  <!-- Loading State -->
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <span>Loading collections...</span>
  </div>

  <!-- Main Content -->
  <div id="content" class="hidden">
    <!-- Status Messages -->
    <div id="status-container"></div>

    <!-- MERGE TAB -->
    <div id="merge-content" class="tab-content active">
      <div class="tab-description">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
        <span>Combine multiple collections into one</span>
      </div>

    <!-- Single Collection Warning (shown when only 1 collection exists) -->
    <div id="single-collection-state" class="single-collection-warning hidden">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      <div>
        <strong>Only one collection found</strong>
        <p>You need at least two variable collections to merge. Try the Split tab to extract groups from your collection.</p>
      </div>
    </div>

    <!-- Target Collection Selection -->
    <div class="section">
      <div class="section-title">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <circle cx="12" cy="12" r="6"></circle>
          <circle cx="12" cy="12" r="2"></circle>
        </svg>
        Target Collection
        <span class="badge">Required</span>
      </div>
      <div class="accordion">
        <button class="accordion-trigger" onclick="toggleAccordion('target-help')">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
          <span>How to choose the right target collection</span>
        </button>
        <div class="accordion-content" id="target-help">
          <div class="accordion-content-inner">
            <p>Choose your most extensive collection with the most modes. Generally this would be the color collection or collection you intend to be the general "theme".</p>
            <p style="margin-top: 8px;">Merging works best when collections have the same or similar modes (e.g. Client 1, Client 2, Client 3). Typically, if you come from separate collections for border radii or spacing, these will not have values for the different skins you want to have. The values will be filled in by the plugin.</p>
            <p style="margin-top: 8px;"><strong>Tip:</strong> If, before merging, you match the modes across collections, you will have MUCH less work.</p>
          </div>
        </div>
      </div>
      <div id="target-list" class="collection-list"></div>
    </div>

    <div class="divider"></div>

    <!-- Source Collections Selection -->
    <div class="section">
      <div class="section-title">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="3" width="7" height="7"></rect>
          <rect x="14" y="3" width="7" height="7"></rect>
          <rect x="14" y="14" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect>
        </svg>
        Source Collections
        <span class="badge" id="source-count">0 selected</span>
      </div>
      <div id="source-list" class="collection-list"></div>
    </div>

    <!-- Mode Mismatch Warning -->
    <div id="mode-warning" class="mode-warning hidden">
      <div class="mode-warning-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
          <line x1="12" y1="9" x2="12" y2="13"></line>
          <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </svg>
      </div>
      <div class="mode-warning-content">
        <strong>Mode count mismatch detected</strong>
        <p id="mode-warning-details"></p>
        <label class="mode-warning-option">
          <input type="checkbox" id="fill-missing-modes" checked>
          <div class="custom-checkbox small"></div>
          <span>Fill missing modes with values from the first mode</span>
        </label>
      </div>
    </div>

    <!-- Preview -->
    <div id="preview" class="preview-section hidden">
      <div class="preview-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        Merge Preview
      </div>
      <div class="preview-stats">
        <div class="stat-item">
          <div class="stat-value" id="preview-vars">0</div>
          <div class="stat-label">Variables</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="preview-sources">0</div>
          <div class="stat-label">Sources</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="preview-target">0</div>
          <div class="stat-label">Target Total</div>
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <!-- Rename Target Collection -->
    <div class="section">
      <div class="section-title">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 20h9"></path>
          <path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"></path>
        </svg>
        Rename Target Collection
        <span class="badge">Optional</span>
      </div>
      <div class="input-group">
        <input type="text" id="target-name" class="text-input" placeholder="Enter new name..." value="Theme">
      </div>
    </div>

    <!-- Actions -->
    <div class="actions">
      <button class="btn btn-secondary" id="btn-cancel">
        Cancel
      </button>
      <button class="btn btn-primary" id="btn-merge" disabled>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M16 3h5v5"></path>
          <path d="M8 3H3v5"></path>
          <path d="M12 22v-8.3a4 4 0 0 0-1.172-2.872L3 3"></path>
          <path d="m15 9 6-6"></path>
        </svg>
        Merge Collections
      </button>
    </div>
    </div>
    <!-- END MERGE TAB -->

    <!-- SPLIT TAB -->
    <div id="split-content" class="tab-content">
      <div class="tab-description">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
        <span>Extract groups into new collection</span>
      </div>

      <!-- Select Collection -->
      <div class="section">
        <div class="section-title">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
          </svg>
          Source Collection
          <span class="badge">Required</span>
        </div>
        <p class="section-hint">Select the collection containing the group you want to extract.</p>
        <div id="split-collection-list" class="collection-list"></div>
      </div>

      <div class="divider"></div>

      <!-- Select Group -->
      <div class="section">
        <div class="section-title">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 3h6l6 18h6"></path>
            <path d="M14 3h7"></path>
          </svg>
          Group to Extract
          <span class="badge">Required</span>
        </div>
        <p class="section-hint">Select the groups you want to extract into a new collection.</p>
        <div id="split-group-list" class="collection-list"></div>
        <div id="split-no-groups" class="no-groups-message hidden">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          <span>No groups found in this collection. Groups are created by using "/" in variable names.</span>
        </div>
      </div>

      <div class="divider"></div>

      <!-- New Collection Name -->
      <div class="section">
        <div class="section-title">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 20h9"></path>
            <path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"></path>
          </svg>
          New Collection Name
          <span class="badge">Required</span>
        </div>
        <input type="text" id="split-new-name" class="text-input" placeholder="Enter collection name...">
      </div>

      <!-- Split Preview -->
      <div id="split-preview" class="preview-section hidden">
        <div class="preview-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10 9 9 9 8 9"></polyline>
          </svg>
          Split Preview
        </div>
        <div class="preview-stats">
          <div class="stat-item">
            <div class="stat-value" id="split-preview-groups">0</div>
            <div class="stat-label">Groups</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="split-preview-vars">0</div>
            <div class="stat-label">Variables</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="split-preview-modes">0</div>
            <div class="stat-label">Modes</div>
          </div>
        </div>
      </div>

      <!-- Split Actions -->
      <div class="actions">
        <button class="btn btn-secondary" id="btn-split-cancel">
          Cancel
        </button>
        <button class="btn btn-primary" id="btn-split" disabled>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M16 3h5v5"></path>
            <path d="M8 3H3v5"></path>
            <path d="M12 22v-8.3a4 4 0 0 0-1.172-2.872L3 3"></path>
            <path d="m15 9 6-6"></path>
          </svg>
          Split Collection
        </button>
      </div>
    </div>
    <!-- END SPLIT TAB -->

    <!-- MOVE TAB -->
    <div id="move-content" class="tab-content">
      <div class="tab-description">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
        <span>Move single group into a new collection</span>
      </div>

      <!-- Select Collection and Group -->
      <div class="section">
        <div class="section-title">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
          </svg>
          Select Group to Move
          <span class="badge">Required</span>
        </div>

        <!-- Unified collection and group view -->
        <div id="move-unified-list" class="collection-list"></div>
      </div>

      <div class="divider"></div>

      <!-- Select Target Collection -->
      <div class="section">
        <div class="section-title">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <circle cx="12" cy="12" r="6"></circle>
            <circle cx="12" cy="12" r="2"></circle>
          </svg>
          Target Collection
          <span class="badge">Required</span>
        </div>
        <p class="section-hint">Choose an existing collection or create a new one.</p>

        <!-- Existing collections -->
        <div id="move-target-list" class="collection-list"></div>

        <!-- Create new collection option -->
        <div class="collection-item" id="move-new-collection-option" onclick="selectMoveNewCollection()">
          <div class="collection-radio"></div>
          <div class="collection-info">
            <div class="collection-name">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              Create new collection
            </div>
          </div>
        </div>

        <!-- New collection name input -->
        <div id="move-new-collection-input" class="input-group hidden" style="margin-top: 10px;">
          <div class="section-title" style="margin-bottom: 8px;">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 20h9"></path>
              <path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"></path>
            </svg>
            Collection Name
          </div>
          <input type="text" id="move-new-collection-name" class="text-input" placeholder="Enter new collection name...">
        </div>
      </div>

      <!-- Move Preview -->
      <div id="move-preview" class="preview-section hidden">
        <div class="preview-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10 9 9 9 8 9"></polyline>
          </svg>
          Move Preview
        </div>
        <div class="preview-stats">
          <div class="stat-item">
            <div class="stat-value" id="move-preview-vars">0</div>
            <div class="stat-label">Variables</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="move-preview-group">-</div>
            <div class="stat-label">Group Path</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="move-preview-modes">0</div>
            <div class="stat-label">Modes</div>
          </div>
        </div>
      </div>

      <!-- Move Actions -->
      <div class="actions">
        <button class="btn btn-secondary" id="btn-move-cancel">
          Cancel
        </button>
        <button class="btn btn-primary" id="btn-move" disabled>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 8L22 12L18 16"></path>
            <path d="M2 12H22"></path>
          </svg>
          Move Group
        </button>
      </div>
    </div>
    <!-- END MOVE TAB -->

    <!-- INFO TAB -->
    <div id="info-content" class="tab-content">
      <div style="text-align: center; padding: 40px 20px;">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin: 0 auto 20px; opacity: 0.6;">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>

        <h2 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px;">
          Obra Variable Collection Manager
        </h2>

        <p style="font-size: 12px; color: var(--text-secondary); line-height: 1.6; margin-bottom: 24px;">
          This plugin was created by <strong>Obra Studio</strong> to help manage variable collections efficiently in Figma.
        </p>

        <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 20px; margin-bottom: 24px;">
          <p style="font-size: 11px; color: var(--text-muted); margin-bottom: 12px;">
            Check out our Figma Community profile
          </p>
          <a href="https://www.figma.com/@obrastudio" target="_blank" class="info-link">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
              <polyline points="15 3 21 3 21 9"></polyline>
              <line x1="10" y1="14" x2="21" y2="3"></line>
            </svg>
            Visit @obrastudio
          </a>
        </div>

        <p style="font-size: 10px; color: var(--text-muted); margin-top: 32px;">
          Version 1.0.0 â€¢ Made with care by Obra Studio
        </p>
      </div>
    </div>
    <!-- END INFO TAB -->
  </div>

  <!-- Empty State -->
  <div id="empty-state" class="empty-state hidden">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
      <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
      <line x1="12" y1="22.08" x2="12" y2="12"></line>
    </svg>
    <h3>No Variable Collections Found</h3>
    <p>Create some variable collections in your Figma file to get started.</p>
  </div>

  <script>
    // State
    let collections = [];
    let targetCollectionId = null;
    let sourceCollectionIds = new Set();

    // DOM Elements
    const loadingEl = document.getElementById('loading');
    const contentEl = document.getElementById('content');
    const emptyStateEl = document.getElementById('empty-state');
    const singleCollectionEl = document.getElementById('single-collection-state');
    const targetListEl = document.getElementById('target-list');
    const sourceListEl = document.getElementById('source-list');
    const sourceCountEl = document.getElementById('source-count');
    const previewEl = document.getElementById('preview');
    const previewVarsEl = document.getElementById('preview-vars');
    const previewSourcesEl = document.getElementById('preview-sources');
    const previewTargetEl = document.getElementById('preview-target');
    const btnMerge = document.getElementById('btn-merge');
    const btnCancel = document.getElementById('btn-cancel');
    const statusContainer = document.getElementById('status-container');
    const modeWarningEl = document.getElementById('mode-warning');
    const modeWarningDetailsEl = document.getElementById('mode-warning-details');
    const fillMissingModesCheckbox = document.getElementById('fill-missing-modes');
    const targetNameInput = document.getElementById('target-name');

    // Split tab elements
    const mergeContentEl = document.getElementById('merge-content');
    const splitContentEl = document.getElementById('split-content');
    const tabMergeEl = document.getElementById('tab-merge');
    const tabSplitEl = document.getElementById('tab-split');
    const splitCollectionListEl = document.getElementById('split-collection-list');
    const splitGroupListEl = document.getElementById('split-group-list');
    const splitNoGroupsEl = document.getElementById('split-no-groups');
    const splitNewNameInput = document.getElementById('split-new-name');
    const splitPreviewEl = document.getElementById('split-preview');
    const splitPreviewVarsEl = document.getElementById('split-preview-vars');
    const splitPreviewModesEl = document.getElementById('split-preview-modes');
    const splitPreviewGroupsEl = document.getElementById('split-preview-groups');
    const btnSplit = document.getElementById('btn-split');
    const btnSplitCancel = document.getElementById('btn-split-cancel');

    // Move tab elements
    const moveContentEl = document.getElementById('move-content');
    const tabMoveEl = document.getElementById('tab-move');
    const moveUnifiedListEl = document.getElementById('move-unified-list');

    // Info tab elements
    const infoContentEl = document.getElementById('info-content');
    const tabInfoEl = document.getElementById('tab-info');
    const moveTargetListEl = document.getElementById('move-target-list');
    const moveNewCollectionOptionEl = document.getElementById('move-new-collection-option');
    const moveNewCollectionInputEl = document.getElementById('move-new-collection-input');
    const moveNewCollectionNameInput = document.getElementById('move-new-collection-name');
    const movePreviewEl = document.getElementById('move-preview');
    const movePreviewVarsEl = document.getElementById('move-preview-vars');
    const movePreviewGroupEl = document.getElementById('move-preview-group');
    const movePreviewModesEl = document.getElementById('move-preview-modes');
    const btnMove = document.getElementById('btn-move');
    const btnMoveCancel = document.getElementById('btn-move-cancel');

    // Split tab state
    let splitCollectionId = null;
    let selectedGroups = new Set();
    let availableGroups = [];

    // Move tab state
    let moveSourceCollectionId = null;
    let moveTargetCollectionId = null;
    let moveIsNewCollection = false;  // Whether creating a new collection
    let moveSelectedGroupPath = null;  // Full path of selected group (e.g., "colors/primary")
    let moveExpandedCollections = new Set();  // Set of expanded collection IDs
    let moveGroupHierarchies = {};  // Group hierarchies by collection ID
    let moveExpandedGroups = {};  // Expanded groups by collection ID

    // Show status message
    function showStatus(message, type = 'info') {
      const icons = {
        success: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>',
        error: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>',
        warning: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>',
        info: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>'
      };
      
      statusContainer.innerHTML = `
        <div class="status-message ${type}">
          ${icons[type]}
          <span>${message}</span>
        </div>
      `;

      // Auto-hide success messages
      if (type === 'success') {
        setTimeout(() => {
          statusContainer.innerHTML = '';
        }, 5000);
      }
    }

    // Render target collection list
    function renderTargetList() {
      targetListEl.innerHTML = collections.map(collection => `
        <div class="collection-item ${targetCollectionId === collection.id ? 'target' : ''}"
             data-id="${collection.id}"
             onclick="selectTarget('${collection.id}')">
          <div class="collection-radio"></div>
          <div class="collection-info">
            <div class="collection-name">${escapeHtml(collection.name)}</div>
            <div class="collection-badges">
              <span class="collection-badge">${collection.modes.length} mode${collection.modes.length > 1 ? 's' : ''}</span>
              <span class="collection-badge">${collection.variableCount} var${collection.variableCount !== 1 ? 's' : ''}</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Render source collection list
    function renderSourceList() {
      const availableCollections = collections.filter(c => c.id !== targetCollectionId);

      sourceListEl.innerHTML = availableCollections.map(collection => `
        <div class="collection-item ${sourceCollectionIds.has(collection.id) ? 'selected' : ''} ${!targetCollectionId ? 'disabled' : ''}"
             data-id="${collection.id}"
             onclick="toggleSource('${collection.id}')">
          <div class="collection-checkbox"></div>
          <div class="collection-info">
            <div class="collection-name">${escapeHtml(collection.name)}</div>
            <div class="collection-badges">
              <span class="collection-badge">${collection.modes.length} mode${collection.modes.length > 1 ? 's' : ''}</span>
              <span class="collection-badge">${collection.variableCount} var${collection.variableCount !== 1 ? 's' : ''}</span>
            </div>
          </div>
        </div>
      `).join('');

      sourceCountEl.textContent = `${sourceCollectionIds.size} selected`;
    }

    // Select target collection
    function selectTarget(id) {
      targetCollectionId = id;
      // Remove target from sources if it was selected
      sourceCollectionIds.delete(id);
      renderTargetList();
      renderSourceList();
      updatePreview();
      updateMergeButton();
    }

    // Toggle source collection
    function toggleSource(id) {
      if (!targetCollectionId) return;
      
      if (sourceCollectionIds.has(id)) {
        sourceCollectionIds.delete(id);
      } else {
        sourceCollectionIds.add(id);
      }
      renderSourceList();
      updatePreview();
      updateMergeButton();
    }

    // Update preview section
    function updatePreview() {
      if (sourceCollectionIds.size === 0) {
        previewEl.classList.add('hidden');
        modeWarningEl.classList.add('hidden');
        return;
      }

      previewEl.classList.remove('hidden');

      const targetCollection = collections.find(c => c.id === targetCollectionId);
      const sourceVarsCount = [...sourceCollectionIds].reduce((sum, id) => {
        const collection = collections.find(c => c.id === id);
        return sum + (collection ? collection.variableCount : 0);
      }, 0);

      previewVarsEl.textContent = sourceVarsCount;
      previewSourcesEl.textContent = sourceCollectionIds.size;
      previewTargetEl.textContent = targetCollection ? targetCollection.variableCount + sourceVarsCount : 0;

      // Check for mode mismatches
      checkModeMismatch();
    }

    // Check if source collections have different mode counts than target
    function checkModeMismatch() {
      if (!targetCollectionId || sourceCollectionIds.size === 0) {
        modeWarningEl.classList.add('hidden');
        return;
      }

      const targetCollection = collections.find(c => c.id === targetCollectionId);
      if (!targetCollection) {
        modeWarningEl.classList.add('hidden');
        return;
      }

      const targetModeCount = targetCollection.modes.length;
      const mismatches = [];

      for (const sourceId of sourceCollectionIds) {
        const sourceCollection = collections.find(c => c.id === sourceId);
        if (sourceCollection && sourceCollection.modes.length !== targetModeCount) {
          mismatches.push({
            name: sourceCollection.name,
            modeCount: sourceCollection.modes.length
          });
        }
      }

      if (mismatches.length > 0) {
        const targetInfo = `<span class="mode-badge">${escapeHtml(targetCollection.name)}</span> has <span class="mode-badge">${targetModeCount} mode${targetModeCount !== 1 ? 's' : ''}</span>`;
        
        const mismatchInfo = mismatches.map(m => 
          `<span class="mode-badge warning">${escapeHtml(m.name)}</span> has <span class="mode-badge warning">${m.modeCount} mode${m.modeCount !== 1 ? 's' : ''}</span>`
        ).join(', ');

        modeWarningDetailsEl.innerHTML = `${targetInfo}, but ${mismatchInfo}.`;
        modeWarningEl.classList.remove('hidden');
      } else {
        modeWarningEl.classList.add('hidden');
      }
    }

    // Update merge button state
    function updateMergeButton() {
      btnMerge.disabled = !targetCollectionId || sourceCollectionIds.size === 0;
    }

    // Handle messages from plugin
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      
      switch (msg.type) {
        case 'collections-loaded':
          collections = msg.collections;
          loadingEl.classList.add('hidden');
          
          if (collections.length === 0) {
            emptyStateEl.classList.remove('hidden');
          } else {
            contentEl.classList.remove('hidden');
            renderTargetList();
            renderSourceList();

            // Show single collection message in merge tab if only one collection
            if (collections.length === 1) {
              singleCollectionEl.classList.remove('hidden');
            } else {
              singleCollectionEl.classList.add('hidden');
            }
          }
          break;

        case 'merge-complete':
          btnMerge.disabled = false;
          btnMerge.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M16 3h5v5"></path>
              <path d="M8 3H3v5"></path>
              <path d="M12 22v-8.3a4 4 0 0 0-1.172-2.872L3 3"></path>
              <path d="m15 9 6-6"></path>
            </svg>
            Merge Collections
          `;
          
          if (msg.errors && msg.errors.length > 0) {
            showStatus(`Moved ${msg.movedCount} variables with ${msg.errors.length} warning(s)`, 'warning');
          } else {
            showStatus(`Successfully moved ${msg.movedCount} variable${msg.movedCount !== 1 ? 's' : ''}!`, 'success');
          }
          
          // Reset selection
          targetCollectionId = null;
          sourceCollectionIds.clear();
          updateSteps();
          
          // Scroll to top so user sees the success message
          window.scrollTo({ top: 0, behavior: 'smooth' });
          break;

        case 'error':
          btnMerge.disabled = false;
          btnMerge.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M16 3h5v5"></path>
              <path d="M8 3H3v5"></path>
              <path d="M12 22v-8.3a4 4 0 0 0-1.172-2.872L3 3"></path>
              <path d="m15 9 6-6"></path>
            </svg>
            Merge Collections
          `;
          showStatus(msg.message, 'error');
          break;

        case 'split-complete':
          btnSplit.disabled = false;
          btnSplit.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M16 3h5v5"></path>
              <path d="M8 3H3v5"></path>
              <path d="M12 22v-8.3a4 4 0 0 0-1.172-2.872L3 3"></path>
              <path d="m15 9 6-6"></path>
            </svg>
            Split Collection
          `;

          if (msg.errors && msg.errors.length > 0) {
            showStatus(`Moved ${msg.movedCount} variables with ${msg.errors.length} warning(s)`, 'warning');
          } else {
            showStatus(`Successfully created "${msg.collectionName}" with ${msg.movedCount} variable${msg.movedCount !== 1 ? 's' : ''}!`, 'success');
          }

          // Reset selection
          splitCollectionId = null;
          selectedGroups.clear();
          splitNewNameInput.value = '';
          renderSplitCollectionList();
          renderSplitGroupList();
          updateSplitPreview();
          updateSplitButton();

          // Scroll to top
          window.scrollTo({ top: 0, behavior: 'smooth' });
          break;

        case 'move-complete':
          btnMove.disabled = false;
          btnMove.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 8L22 12L18 16"></path>
              <path d="M2 12H22"></path>
            </svg>
            Move Group
          `;

          if (msg.errors && msg.errors.length > 0) {
            showStatus(`Moved ${msg.movedCount} variables with ${msg.errors.length} warning(s)`, 'warning');
          } else {
            const targetName = msg.newCollectionName || 'target collection';
            showStatus(`Successfully moved ${msg.movedCount} variable${msg.movedCount !== 1 ? 's' : ''} to "${targetName}"!`, 'success');
          }

          // Reset selection
          moveSourceCollectionId = null;
          moveTargetCollectionId = null;
          moveIsNewCollection = false;
          moveSelectedGroupPath = null;
          moveExpandedCollections.clear();
          moveExpandedGroups = {};
          moveNewCollectionNameInput.value = '';
          renderMoveUnifiedList();
          renderMoveTargetList();
          updateMovePreview();
          updateMoveButton();

          // Scroll to top
          window.scrollTo({ top: 0, behavior: 'smooth' });
          break;
      }
    };

    // Merge button click
    btnMerge.addEventListener('click', () => {
      if (!targetCollectionId || sourceCollectionIds.size === 0) return;
      
      btnMerge.disabled = true;
      btnMerge.innerHTML = `
        <div class="spinner" style="width: 14px; height: 14px; margin: 0; border-width: 2px;"></div>
        Merging...
      `;

      parent.postMessage({
        pluginMessage: {
          type: 'merge-collections',
          targetCollectionId: targetCollectionId,
          sourceCollectionIds: [...sourceCollectionIds],
          deleteSourceCollections: true,
          groupByCollection: true,
          fillMissingModes: fillMissingModesCheckbox.checked,
          newTargetName: targetNameInput.value.trim(),
          groupTargetVariables: true
        }
      }, '*');
    });

    // Cancel button click
    btnCancel.addEventListener('click', () => {
      parent.postMessage({
        pluginMessage: { type: 'cancel' }
      }, '*');
    });

    // Utility: Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Toggle accordion
    function toggleAccordion(id) {
      const trigger = document.querySelector(`button[onclick="toggleAccordion('${id}')"]`);
      const content = document.getElementById(id);

      if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        trigger.classList.remove('expanded');
      } else {
        content.classList.add('expanded');
        trigger.classList.add('expanded');
      }
    }

    // =====================
    // SPLIT TAB FUNCTIONS
    // =====================

    // Switch between tabs
    function switchTab(tab) {
      // Remove all active states
      tabMergeEl.classList.remove('active');
      tabSplitEl.classList.remove('active');
      tabMoveEl.classList.remove('active');
      tabInfoEl.classList.remove('active');
      mergeContentEl.classList.remove('active');
      splitContentEl.classList.remove('active');
      moveContentEl.classList.remove('active');
      infoContentEl.classList.remove('active');

      // Activate selected tab
      if (tab === 'merge') {
        tabMergeEl.classList.add('active');
        mergeContentEl.classList.add('active');
      } else if (tab === 'split') {
        tabSplitEl.classList.add('active');
        splitContentEl.classList.add('active');
        renderSplitCollectionList();
      } else if (tab === 'move') {
        tabMoveEl.classList.add('active');
        moveContentEl.classList.add('active');
        renderMoveUnifiedList();
      } else if (tab === 'info') {
        tabInfoEl.classList.add('active');
        infoContentEl.classList.add('active');
      }
    }

    // Render collection list for split tab
    function renderSplitCollectionList() {
      splitCollectionListEl.innerHTML = collections.map(collection => `
        <div class="collection-item ${splitCollectionId === collection.id ? 'target' : ''}"
             data-id="${collection.id}"
             onclick="selectSplitCollection('${collection.id}')">
          <div class="collection-radio"></div>
          <div class="collection-info">
            <div class="collection-name">${escapeHtml(collection.name)}</div>
            <div class="collection-badges">
              <span class="collection-badge">${collection.modes.length} mode${collection.modes.length > 1 ? 's' : ''}</span>
              <span class="collection-badge">${collection.variableCount} var${collection.variableCount !== 1 ? 's' : ''}</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Select collection for splitting
    function selectSplitCollection(id) {
      splitCollectionId = id;
      selectedGroups.clear();
      renderSplitCollectionList();
      updateAvailableGroups();
      renderSplitGroupList();
      updateSplitPreview();
      updateSplitButton();
    }

    // Extract groups from collection's variables
    function updateAvailableGroups() {
      availableGroups = [];
      
      if (!splitCollectionId) return;
      
      const collection = collections.find(c => c.id === splitCollectionId);
      if (!collection || !collection.variables) return;
      
      const groupSet = new Set();
      
      for (const variable of collection.variables) {
        const slashIndex = variable.name.indexOf('/');
        if (slashIndex > 0) {
          const groupName = variable.name.substring(0, slashIndex);
          groupSet.add(groupName);
        }
      }
      
      // Convert to array with variable counts
      for (const groupName of groupSet) {
        const varCount = collection.variables.filter(v => v.name.startsWith(groupName + '/')).length;
        availableGroups.push({
          name: groupName,
          variableCount: varCount
        });
      }
      
      // Sort alphabetically
      availableGroups.sort((a, b) => a.name.localeCompare(b.name));
    }

    // Render group list for split tab
    function renderSplitGroupList() {
      if (!splitCollectionId) {
        splitGroupListEl.innerHTML = '';
        splitNoGroupsEl.classList.add('hidden');
        return;
      }
      
      if (availableGroups.length === 0) {
        splitGroupListEl.innerHTML = '';
        splitNoGroupsEl.classList.remove('hidden');
        return;
      }
      
      splitNoGroupsEl.classList.add('hidden');
      splitGroupListEl.innerHTML = availableGroups.map((group, index) => `
        <div class="collection-item ${selectedGroups.has(group.name) ? 'selected' : ''}" 
             data-group-index="${index}">
          <div class="collection-checkbox"></div>
          <div class="collection-info">
            <div class="collection-name">${escapeHtml(group.name)}</div>
          </div>
          <div class="collection-count">${group.variableCount} var${group.variableCount !== 1 ? 's' : ''}</div>
        </div>
      `).join('');
      
      // Add click handlers
      splitGroupListEl.querySelectorAll('.collection-item').forEach(item => {
        item.addEventListener('click', () => {
          const index = parseInt(item.dataset.groupIndex);
          const groupName = availableGroups[index].name;
          toggleGroup(groupName);
        });
      });
    }

    // Toggle a group selection
    function toggleGroup(groupName) {
      if (selectedGroups.has(groupName)) {
        selectedGroups.delete(groupName);
      } else {
        selectedGroups.add(groupName);
      }
      renderSplitGroupList();
      updateSplitPreview();
      updateSplitButton();
    }

    // Update split preview
    function updateSplitPreview() {
      if (selectedGroups.size === 0) {
        splitPreviewEl.classList.add('hidden');
        return;
      }
      
      splitPreviewEl.classList.remove('hidden');
      
      const collection = collections.find(c => c.id === splitCollectionId);
      
      // Sum up variables from all selected groups
      let totalVars = 0;
      for (const groupName of selectedGroups) {
        const group = availableGroups.find(g => g.name === groupName);
        if (group) {
          totalVars += group.variableCount;
        }
      }
      
      splitPreviewVarsEl.textContent = totalVars;
      splitPreviewModesEl.textContent = collection ? collection.modes.length : 0;
      splitPreviewGroupsEl.textContent = selectedGroups.size;
    }

    // Update split button state
    function updateSplitButton() {
      btnSplit.disabled = !splitCollectionId || selectedGroups.size === 0 || !splitNewNameInput.value.trim();
    }

    // Split button click
    btnSplit.addEventListener('click', () => {
      if (!splitCollectionId || selectedGroups.size === 0 || !splitNewNameInput.value.trim()) return;
      
      btnSplit.disabled = true;
      btnSplit.innerHTML = `
        <div class="spinner" style="width: 14px; height: 14px; margin: 0; border-width: 2px;"></div>
        Splitting...
      `;

      parent.postMessage({
        pluginMessage: {
          type: 'split-collection',
          sourceCollectionId: splitCollectionId,
          groupNames: [...selectedGroups],
          newCollectionName: splitNewNameInput.value.trim()
        }
      }, '*');
    });

    // Update button state when collection name changes
    splitNewNameInput.addEventListener('input', updateSplitButton);

    // Split cancel button click
    btnSplitCancel.addEventListener('click', () => {
      parent.postMessage({
        pluginMessage: { type: 'cancel' }
      }, '*');
    });

    // =====================
    // MOVE TAB FUNCTIONS
    // =====================

    // Build group hierarchies for all collections
    function buildAllMoveGroupHierarchies() {
      moveGroupHierarchies = {};

      for (const collection of collections) {
        const hierarchy = {};

        if (!collection.variables) continue;

        // Build hierarchy from variable names
        for (const variable of collection.variables) {
          const parts = variable.name.split('/');

          // Only process if there's at least one group level
          if (parts.length > 1) {
            let currentLevel = hierarchy;

            // Navigate/create the hierarchy (exclude the last part which is the variable name)
            for (let i = 0; i < parts.length - 1; i++) {
              const part = parts[i];

              if (!currentLevel[part]) {
                currentLevel[part] = {
                  name: part,
                  fullPath: parts.slice(0, i + 1).join('/'),
                  children: {},
                  variableCount: 0
                };
              }

              // Count variables at this level
              if (i === parts.length - 2) {
                currentLevel[part].variableCount++;
              }

              currentLevel = currentLevel[part].children;
            }
          }
        }

        moveGroupHierarchies[collection.id] = hierarchy;
      }
    }

    // Render unified collection and group list
    function renderMoveUnifiedList() {
      buildAllMoveGroupHierarchies();

      moveUnifiedListEl.innerHTML = collections.map(collection => {
        const isExpanded = moveExpandedCollections.has(collection.id);
        const hasGroups = Object.keys(moveGroupHierarchies[collection.id] || {}).length > 0;

        return `
          <div class="collection-with-groups">
            <div class="collection-header" onclick="toggleMoveCollection('${collection.id}')">
              <div class="collection-expand-icon ${isExpanded ? 'expanded' : ''}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </div>
              <div class="collection-info">
                <div class="collection-name">${escapeHtml(collection.name)}</div>
                <div class="collection-badges">
                  <span class="collection-badge">${collection.modes.length} mode${collection.modes.length > 1 ? 's' : ''}</span>
                  <span class="collection-badge">${collection.variableCount} var${collection.variableCount !== 1 ? 's' : ''}</span>
                </div>
              </div>
            </div>
            ${hasGroups ? `
              <div class="collection-groups-container ${isExpanded ? 'expanded' : ''}">
                <div class="tree-view">
                  ${renderTreeLevel(moveGroupHierarchies[collection.id], collection.id)}
                </div>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    // Toggle collection expand/collapse
    function toggleMoveCollection(collectionId) {
      if (moveExpandedCollections.has(collectionId)) {
        moveExpandedCollections.delete(collectionId);
      } else {
        moveExpandedCollections.add(collectionId);
      }

      renderMoveUnifiedList();
    }

    // Render a level of the tree recursively
    function renderTreeLevel(groupLevel, collectionId) {
      const groups = Object.values(groupLevel);

      return groups.map(group => {
        const hasChildren = Object.keys(group.children).length > 0;
        const expandKey = `${collectionId}:${group.fullPath}`;
        const isExpanded = moveExpandedGroups[expandKey];
        const isSelected = moveSelectedGroupPath === group.fullPath && moveSourceCollectionId === collectionId;

        return `
          <div class="tree-item">
            <div class="tree-item-content ${isSelected ? 'selected' : ''}"
                 onclick="selectMoveGroup('${collectionId}', '${escapeHtml(group.fullPath)}', event)">
              <div class="tree-item-expand ${hasChildren ? (isExpanded ? 'expanded' : '') : 'empty'}"
                   onclick="toggleMoveGroupExpand('${collectionId}', '${escapeHtml(group.fullPath)}', event)">
                ${hasChildren ? `
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="9 18 15 12 9 6"></polyline>
                  </svg>
                ` : ''}
              </div>
              <div class="tree-item-radio"></div>
              <div class="tree-item-info">
                <span class="tree-item-name">${escapeHtml(group.name)}</span>
                <span class="tree-item-count">${group.variableCount} var${group.variableCount !== 1 ? 's' : ''}</span>
              </div>
            </div>
            ${hasChildren ? `
              <div class="tree-item-children ${isExpanded ? 'expanded' : ''}">
                ${renderTreeLevel(group.children, collectionId)}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    // Toggle group expand/collapse
    function toggleMoveGroupExpand(collectionId, groupPath, event) {
      event.stopPropagation();

      const expandKey = `${collectionId}:${groupPath}`;
      if (moveExpandedGroups[expandKey]) {
        delete moveExpandedGroups[expandKey];
      } else {
        moveExpandedGroups[expandKey] = true;
      }

      renderMoveUnifiedList();
    }

    // Select a group
    function selectMoveGroup(collectionId, groupPath, event) {
      if (event) {
        // Check if we clicked on the expand button
        if (event.target.closest('.tree-item-expand')) {
          return;
        }
      }

      // Toggle selection
      if (moveSelectedGroupPath === groupPath && moveSourceCollectionId === collectionId) {
        moveSelectedGroupPath = null;
        moveSourceCollectionId = null;
      } else {
        moveSelectedGroupPath = groupPath;
        moveSourceCollectionId = collectionId;

        // Auto-populate new collection name if "Create new collection" is active
        if (moveIsNewCollection && !moveNewCollectionNameInput.value.trim()) {
          const sourceCollection = collections.find(c => c.id === collectionId);
          const collectionName = sourceCollection ? sourceCollection.name : '';
          const fullName = collectionName + ' ' + groupPath;
          moveNewCollectionNameInput.value = fullName.replace(/\//g, ' ').trim();
        }
      }

      renderMoveUnifiedList();
      renderMoveTargetList();
      updateMovePreview();
      updateMoveButton();
    }

    // Render target collection list
    function renderMoveTargetList() {
      const availableCollections = collections.filter(c => c.id !== moveSourceCollectionId);

      if (availableCollections.length === 0) {
        moveTargetListEl.innerHTML = '';
      } else {
        moveTargetListEl.innerHTML = availableCollections.map(collection => `
          <div class="collection-item ${!moveIsNewCollection && moveTargetCollectionId === collection.id ? 'target' : ''} ${!moveSourceCollectionId ? 'disabled' : ''}"
               data-id="${collection.id}"
               onclick="selectMoveTargetCollection('${collection.id}')">
            <div class="collection-radio"></div>
            <div class="collection-info">
              <div class="collection-name">${escapeHtml(collection.name)}</div>
              <div class="collection-badges">
                <span class="collection-badge">${collection.modes.length} mode${collection.modes.length > 1 ? 's' : ''}</span>
                <span class="collection-badge">${collection.variableCount} var${collection.variableCount !== 1 ? 's' : ''}</span>
              </div>
            </div>
          </div>
        `).join('');
      }

      // Update new collection option styling
      if (moveIsNewCollection) {
        moveNewCollectionOptionEl.classList.add('target');
      } else {
        moveNewCollectionOptionEl.classList.remove('target');
      }

      // Show/hide new collection input
      if (moveIsNewCollection) {
        moveNewCollectionInputEl.classList.remove('hidden');
      } else {
        moveNewCollectionInputEl.classList.add('hidden');
      }
    }

    // Select target collection
    function selectMoveTargetCollection(id) {
      if (!moveSourceCollectionId) return;

      moveTargetCollectionId = id;
      moveIsNewCollection = false;
      renderMoveTargetList();
      updateMovePreview();
      updateMoveButton();
    }

    // Select new collection option
    function selectMoveNewCollection() {
      if (!moveSourceCollectionId) return;

      moveTargetCollectionId = null;
      moveIsNewCollection = true;

      // Auto-populate with collection name + group path (replace / with space)
      if (moveSelectedGroupPath && moveSourceCollectionId && !moveNewCollectionNameInput.value.trim()) {
        const sourceCollection = collections.find(c => c.id === moveSourceCollectionId);
        const collectionName = sourceCollection ? sourceCollection.name : '';
        const fullName = collectionName + ' ' + moveSelectedGroupPath;
        moveNewCollectionNameInput.value = fullName.replace(/\//g, ' ').trim();
      }

      renderMoveTargetList();
      updateMovePreview();
      updateMoveButton();

      // Focus on the input field
      setTimeout(() => {
        moveNewCollectionNameInput.focus();
      }, 100);
    }

    // Update move preview
    function updateMovePreview() {
      const hasTarget = moveIsNewCollection ? moveNewCollectionNameInput.value.trim() : moveTargetCollectionId;

      if (!moveSelectedGroupPath || !hasTarget) {
        movePreviewEl.classList.add('hidden');
        return;
      }

      movePreviewEl.classList.remove('hidden');

      const sourceCollection = collections.find(c => c.id === moveSourceCollectionId);

      // Count variables in the selected group
      let varCount = 0;
      if (sourceCollection && sourceCollection.variables) {
        const prefix = moveSelectedGroupPath + '/';
        varCount = sourceCollection.variables.filter(v => v.name.startsWith(prefix)).length;
      }

      movePreviewVarsEl.textContent = varCount;
      movePreviewGroupEl.textContent = moveSelectedGroupPath;
      movePreviewModesEl.textContent = sourceCollection ? sourceCollection.modes.length : 0;
    }

    // Update move button state
    function updateMoveButton() {
      const hasTarget = moveIsNewCollection
        ? moveNewCollectionNameInput.value.trim()
        : moveTargetCollectionId;

      btnMove.disabled = !moveSourceCollectionId || !moveSelectedGroupPath || !hasTarget;
    }

    // Move button click
    btnMove.addEventListener('click', () => {
      const hasTarget = moveIsNewCollection
        ? moveNewCollectionNameInput.value.trim()
        : moveTargetCollectionId;

      if (!moveSourceCollectionId || !moveSelectedGroupPath || !hasTarget) return;

      btnMove.disabled = true;
      btnMove.innerHTML = `
        <div class="spinner" style="width: 14px; height: 14px; margin: 0; border-width: 2px;"></div>
        Moving...
      `;

      parent.postMessage({
        pluginMessage: {
          type: 'move-group',
          sourceCollectionId: moveSourceCollectionId,
          targetCollectionId: moveIsNewCollection ? null : moveTargetCollectionId,
          newCollectionName: moveIsNewCollection ? moveNewCollectionNameInput.value.trim() : null,
          groupPath: moveSelectedGroupPath
        }
      }, '*');
    });

    // Update button state when new collection name changes
    moveNewCollectionNameInput.addEventListener('input', () => {
      updateMovePreview();
      updateMoveButton();
    });

    // Move cancel button click
    btnMoveCancel.addEventListener('click', () => {
      parent.postMessage({
        pluginMessage: { type: 'cancel' }
      }, '*');
    });

    // Request initial data
    parent.postMessage({
      pluginMessage: { type: 'load-collections' }
    }, '*');
  </script>
</body>
</html>
