<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f5f5f5;
      --bg-tertiary: #ebebeb;
      --bg-code: #1e1e1e;
      --text-primary: #1a1a1a;
      --text-secondary: #666666;
      --text-tertiary: #999999;
      --text-code: #d4d4d4;
      --border-color: #e0e0e0;
      --accent: #0d99ff;
      --accent-hover: #0b85e0;
      --success: #14ae5c;
    }
    
    .figma-dark {
      --bg-primary: #2c2c2c;
      --bg-secondary: #383838;
      --bg-tertiary: #444444;
      --bg-code: #1a1a1a;
      --text-primary: #ffffff;
      --text-secondary: #b3b3b3;
      --text-tertiary: #808080;
      --text-code: #d4d4d4;
      --border-color: #444444;
      --accent: #0d99ff;
      --accent-hover: #3dacff;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 12px;
      line-height: 1.5;
      color: var(--text-primary);
      background: var(--bg-primary);
      padding: 16px;
      min-height: 100vh;
    }
    
    .header {
      margin-bottom: 16px;
    }
    
    .header h1 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .header p {
      color: var(--text-secondary);
      font-size: 11px;
    }
    
    .form-group {
      margin-bottom: 12px;
    }
    
    .form-label {
      display: block;
      font-size: 11px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    
    .select-wrapper {
      position: relative;
    }
    
    .select-wrapper::after {
      content: '';
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-top: 5px solid var(--text-secondary);
      pointer-events: none;
    }
    
    select {
      width: 100%;
      height: 32px;
      padding: 0 32px 0 12px;
      font-size: 12px;
      font-family: inherit;
      color: var(--text-primary);
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      cursor: pointer;
      appearance: none;
    }
    
    select:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    select:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    
    .checkbox-wrapper input[type="checkbox"] {
      width: 16px;
      height: 16px;
      margin: 0;
      cursor: pointer;
      accent-color: var(--accent);
    }
    
    .checkbox-label {
      font-size: 12px;
      color: var(--text-primary);
    }
    
    .btn {
      width: 100%;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 0 16px;
      font-size: 12px;
      font-weight: 500;
      font-family: inherit;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: var(--accent);
      color: white;
      margin-bottom: 16px;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn:hover:not(:disabled) {
      background: var(--accent-hover);
    }
    
    .icon {
      width: 14px;
      height: 14px;
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      gap: 0;
      margin-bottom: 0;
      border-bottom: 1px solid var(--border-color);
    }
    
    .tab {
      flex: 1;
      padding: 10px 16px;
      font-size: 12px;
      font-weight: 500;
      font-family: inherit;
      color: var(--text-secondary);
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .tab:hover {
      color: var(--text-primary);
    }
    
    .tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Code panel */
    .code-container {
      background: var(--bg-code);
      border-radius: 0 0 8px 8px;
      overflow: hidden;
    }
    
    .code-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.05);
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .code-filename {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-code);
      opacity: 0.7;
    }
    
    .code-actions {
      display: flex;
      gap: 6px;
    }
    
    .code-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      height: 24px;
      padding: 0 8px;
      font-size: 10px;
      font-weight: 500;
      font-family: inherit;
      color: var(--text-code);
      background: rgba(255, 255, 255, 0.08);
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .code-btn:hover {
      background: rgba(255, 255, 255, 0.15);
    }
    
    .code-btn.copied {
      background: var(--success);
      color: white;
    }
    
    .code-preview {
      height: 280px;
      overflow: auto;
      padding: 12px;
    }
    
    .code-preview pre {
      font-family: 'SF Mono', Monaco, Consolas, monospace;
      font-size: 11px;
      line-height: 1.6;
      color: var(--text-code);
      white-space: pre;
      margin: 0;
    }
    
    .code-preview .selector { color: #c586c0; }
    .code-preview .property { color: #9cdcfe; }
    .code-preview .value { color: #ce9178; }
    .code-preview .comment { color: #6a9955; }
    
    /* Preview panel */
    .preview-container {
      background: white;
      border-radius: 0 0 8px 8px;
      border: 1px solid var(--border-color);
      border-top: none;
      overflow: hidden;
    }
    
    .preview-frame {
      width: 100%;
      height: 400px;
      border: none;
    }
    
    /* Empty state */
    .empty-state {
      padding: 40px 20px;
      text-align: center;
      color: var(--text-tertiary);
    }
    
    .empty-state svg {
      width: 48px;
      height: 48px;
      margin-bottom: 12px;
      opacity: 0.4;
    }
    
    .empty-state p {
      font-size: 12px;
    }
    
    /* Notification */
    .notification {
      position: fixed;
      bottom: 16px;
      left: 16px;
      right: 16px;
      padding: 12px 16px;
      background: var(--bg-code);
      color: white;
      border-radius: 6px;
      font-size: 12px;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.2s;
    }
    
    .notification.show {
      transform: translateY(0);
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Variables â†’ Tailwind CSS</h1>
    <p>Export Figma variables to Tailwind v4 / shadcn format</p>
  </div>
  
  <div class="form-group">
    <label class="form-label">Collection</label>
    <div class="select-wrapper">
      <select id="collection-select" disabled>
        <option value="">Loading...</option>
      </select>
    </div>
  </div>
  
  <div class="form-group">
    <label class="form-label">Mode</label>
    <div class="select-wrapper">
      <select id="mode-select" disabled>
        <option value="">Select collection first</option>
      </select>
    </div>
  </div>
  
  <button class="btn" id="generate-btn" disabled>
    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
    </svg>
    Generate
  </button>
  
  <div id="output-section" style="display: none;">
    <div class="tabs">
      <button class="tab active" data-tab="code">Code</button>
      <button class="tab" data-tab="preview">Preview</button>
    </div>
    
    <div id="code-tab" class="tab-content active">
      <div class="code-container">
        <div class="code-header">
          <span class="code-filename" id="code-filename">theme.css</span>
          <div class="code-actions">
            <button class="code-btn" id="copy-btn">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2"/>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
              </svg>
              Copy
            </button>
            <button class="code-btn" id="download-btn">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7,10 12,15 17,10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Download
            </button>
          </div>
        </div>
        <div class="code-preview">
          <pre id="code-content"></pre>
        </div>
      </div>
    </div>
    
    <div id="preview-tab" class="tab-content">
      <div class="preview-container">
        <iframe id="preview-frame" class="preview-frame"></iframe>
      </div>
    </div>
  </div>
  
  <div class="empty-state" id="empty-state">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
      <polyline points="14 2 14 8 20 8"/>
      <line x1="16" y1="13" x2="8" y2="13"/>
      <line x1="16" y1="17" x2="8" y2="17"/>
    </svg>
    <p>Select a collection and mode, then click Generate</p>
  </div>
  
  <div class="notification" id="notification"></div>
  
  <script>
    let collections = [];
    let currentStylesheet = '';
    let currentModeName = '';
    
    const collectionSelect = document.getElementById('collection-select');
    const modeSelect = document.getElementById('mode-select');
    const generateBtn = document.getElementById('generate-btn');
    const outputSection = document.getElementById('output-section');
    const emptyState = document.getElementById('empty-state');
    const codeContent = document.getElementById('code-content');
    const codeFilename = document.getElementById('code-filename');
    const copyBtn = document.getElementById('copy-btn');
    const downloadBtn = document.getElementById('download-btn');
    const notification = document.getElementById('notification');
    const previewFrame = document.getElementById('preview-frame');
    const tabs = document.querySelectorAll('.tab');
    
    // Dark mode detection
    if (document.body.dataset.theme === 'dark' || 
        window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.body.classList.add('figma-dark');
    }
    
    // Tab switching
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
      });
    });
    
    collectionSelect.addEventListener('change', onCollectionChange);
    modeSelect.addEventListener('change', onModeChange);
    generateBtn.addEventListener('click', onGenerate);
    copyBtn.addEventListener('click', onCopy);
    downloadBtn.addEventListener('click', onDownload);
    
    function onCollectionChange() {
      const selected = collections.find(c => c.id === collectionSelect.value);
      modeSelect.innerHTML = '';
      
      if (selected && selected.modes.length > 0) {
        selected.modes.forEach(mode => {
          const option = document.createElement('option');
          option.value = mode.modeId;
          option.textContent = mode.name;
          modeSelect.appendChild(option);
        });
        modeSelect.disabled = false;
      } else {
        modeSelect.innerHTML = '<option value="">No modes</option>';
        modeSelect.disabled = true;
      }
      updateGenerateButton();
    }
    
    function onModeChange() {
      updateGenerateButton();
    }
    
    function updateGenerateButton() {
      generateBtn.disabled = !collectionSelect.value || !modeSelect.value;
    }
    
    function onGenerate() {
      const selected = collections.find(c => c.id === collectionSelect.value);
      const mode = selected?.modes.find(m => m.modeId === modeSelect.value);
      
      if (selected && mode) {
        parent.postMessage({
          pluginMessage: {
            type: 'generate-stylesheet',
            collectionId: collectionSelect.value,
            modeId: modeSelect.value,
            modeName: mode.name
          }
        }, '*');
      }
    }
    
    function onCopy() {
      // Create a temporary textarea to copy from (works in sandboxed iframes)
      const textarea = document.createElement('textarea');
      textarea.value = currentStylesheet;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      
      try {
        document.execCommand('copy');
        copyBtn.classList.add('copied');
        copyBtn.innerHTML = `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>Copied!`;
        setTimeout(() => {
          copyBtn.classList.remove('copied');
          copyBtn.innerHTML = `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>Copy`;
        }, 2000);
      } catch (err) {
        console.error('Copy failed:', err);
      }
      
      document.body.removeChild(textarea);
    }
    
    function onDownload() {
      const filename = `${currentModeName.toLowerCase().replace(/\s+/g, '-')}-theme.css`;
      const blob = new Blob([currentStylesheet], { type: 'text/css' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
      showNotification(`Downloaded ${filename}`);
    }
    
    function showNotification(message) {
      notification.textContent = message;
      notification.classList.add('show');
      setTimeout(() => notification.classList.remove('show'), 3000);
    }
    
    function highlightCSS(css) {
      return css
        .replace(/(:root|\.dark)/g, '<span class="selector">$1</span>')
        .replace(/(@theme inline)/g, '<span class="selector">$1</span>')
        .replace(/(--[\w-]+):/g, '<span class="property">$1</span>:')
        .replace(/: ([^;]+);/g, ': <span class="value">$1</span>;');
    }
    
    function updatePreview(css) {
      // Extract @theme inline variables and convert to :root variables for preview
      let previewCSS = css;
      
      // Extract variables from @theme inline block and add them to :root
      // Use a more robust regex that handles multiline content
      const themeMatch = css.match(/@theme inline \{([\s\S]*?)\n\}/);
      if (themeMatch) {
        const themeVars = themeMatch[1];
        // Find the :root block and append theme vars to it
        previewCSS = css.replace(/(:root \{[\s\S]*?)(\n\})/, (match, rootContent, closing) => {
          return rootContent + '\n' + themeVars + closing;
        });
        // Remove the @theme inline block since browsers don't understand it
        previewCSS = previewCSS.replace(/@theme inline \{[\s\S]*?\n\}/, '');
      }
      
      const previewHTML = `<!DOCTYPE html>
<html>
<head>
  <style>
    ${previewCSS}
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: system-ui, sans-serif; 
      font-size: 11px;
      padding: 16px;
      background: var(--background, #fff);
      color: var(--foreground, #000);
    }
    .section { margin-bottom: 16px; }
    .section-title { 
      font-size: 10px; 
      font-weight: 600; 
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted-foreground, #666);
      margin-bottom: 8px;
      padding-bottom: 4px;
      border-bottom: 1px solid var(--border, #eee);
    }
    .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; }
    .color-box { 
      aspect-ratio: 1; 
      border-radius: 6px; 
      display: flex; 
      align-items: flex-end;
      padding: 4px;
      font-size: 8px;
      font-weight: 500;
    }
    .btn-row { display: flex; gap: 6px; flex-wrap: wrap; }
    .btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 500;
      border: none;
      cursor: pointer;
    }
    .card {
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border, #eee);
    }
    .input {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border, #eee);
      border-radius: 6px;
      font-size: 11px;
      background: var(--input, #fff);
      color: var(--foreground, #000);
    }
    .input:focus { outline: 2px solid var(--ring, #0066ff); outline-offset: 1px; }
    .chart-row { display: flex; gap: 4px; }
    .chart-bar { flex: 1; height: 24px; border-radius: 4px; }
    .radius-row { display: flex; gap: 6px; align-items: center; }
    .radius-box { width: 32px; height: 32px; background: var(--primary, #000); }
    .shadow-row { display: flex; gap: 8px; }
    .shadow-box { 
      flex: 1; 
      height: 40px; 
      background: var(--card, #fff); 
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      color: var(--muted-foreground, #666);
    }
  </style>
</head>
<body>
  <div class="section">
    <div class="section-title">Colors</div>
    <div class="color-grid">
      <div class="color-box" style="background: var(--primary);">
        <span style="color: var(--primary-foreground);">Primary</span>
      </div>
      <div class="color-box" style="background: var(--secondary); border: 1px solid var(--border);">
        <span style="color: var(--secondary-foreground);">Secondary</span>
      </div>
      <div class="color-box" style="background: var(--accent); border: 1px solid var(--border);">
        <span style="color: var(--accent-foreground);">Accent</span>
      </div>
      <div class="color-box" style="background: var(--muted);">
        <span style="color: var(--muted-foreground);">Muted</span>
      </div>
      <div class="color-box" style="background: var(--destructive);">
        <span style="color: var(--destructive-foreground, #fff);">Destructive</span>
      </div>
    </div>
  </div>
  
  <div class="section">
    <div class="section-title">Chart Colors</div>
    <div class="chart-row">
      <div class="chart-bar" style="background: var(--chart-1);"></div>
      <div class="chart-bar" style="background: var(--chart-2);"></div>
      <div class="chart-bar" style="background: var(--chart-3);"></div>
      <div class="chart-bar" style="background: var(--chart-4);"></div>
      <div class="chart-bar" style="background: var(--chart-5);"></div>
    </div>
  </div>
  
  <div class="section">
    <div class="section-title">Buttons</div>
    <div class="btn-row">
      <button class="btn" style="background: var(--primary); color: var(--primary-foreground);">Primary</button>
      <button class="btn" style="background: var(--secondary); color: var(--secondary-foreground);">Secondary</button>
      <button class="btn" style="background: var(--destructive); color: var(--destructive-foreground, #fff);">Destructive</button>
      <button class="btn" style="background: transparent; border: 1px solid var(--border); color: var(--foreground);">Outline</button>
    </div>
  </div>
  
  <div class="section">
    <div class="section-title">Card & Input</div>
    <div class="card" style="background: var(--card); color: var(--card-foreground);">
      <div style="font-weight: 600; margin-bottom: 8px;">Card Title</div>
      <input class="input" placeholder="Input field..." />
    </div>
  </div>
  
  <div class="section">
    <div class="section-title">Border Radius</div>
    <div class="radius-row">
      <div class="radius-box" style="border-radius: var(--radius-sm, 0.25rem);"></div>
      <div class="radius-box" style="border-radius: var(--radius-md, 0.375rem);"></div>
      <div class="radius-box" style="border-radius: var(--radius-lg, 0.5rem);"></div>
      <div class="radius-box" style="border-radius: var(--radius-xl, 0.75rem);"></div>
      <div class="radius-box" style="border-radius: var(--radius-2xl, 1rem);"></div>
      <div class="radius-box" style="border-radius: 9999px;"></div>
    </div>
  </div>
  
  <div class="section">
    <div class="section-title">Shadows</div>
    <div class="shadow-row">
      <div class="shadow-box" style="box-shadow: var(--shadow-sm, 0 1px 2px rgba(0,0,0,0.1));">sm</div>
      <div class="shadow-box" style="box-shadow: var(--shadow-md, 0 4px 6px rgba(0,0,0,0.1));">md</div>
      <div class="shadow-box" style="box-shadow: var(--shadow-lg, 0 10px 15px rgba(0,0,0,0.1));">lg</div>
      <div class="shadow-box" style="box-shadow: var(--shadow-xl, 0 20px 25px rgba(0,0,0,0.1));">xl</div>
    </div>
  </div>
  
  <div class="section">
    <div class="section-title">Sidebar</div>
    <div style="display: flex; gap: 8px;">
      <div style="width: 80px; background: var(--sidebar, #f5f5f5); border-radius: 6px; padding: 8px; border: 1px solid var(--sidebar-border, #eee);">
        <div style="font-size: 9px; color: var(--sidebar-foreground, #666); margin-bottom: 6px;">Menu</div>
        <div style="padding: 4px 6px; background: var(--sidebar-primary); color: var(--sidebar-primary-foreground); border-radius: 4px; font-size: 9px; margin-bottom: 4px;">Active</div>
        <div style="padding: 4px 6px; color: var(--sidebar-foreground, #666); font-size: 9px;">Item</div>
      </div>
      <div style="flex: 1; background: var(--card, #fff); border-radius: 6px; padding: 8px; border: 1px solid var(--border, #eee);">
        <span style="color: var(--muted-foreground, #666); font-size: 9px;">Content area</span>
      </div>
    </div>
  </div>
</body>
</html>`;
      
      previewFrame.srcdoc = previewHTML;
    }
    
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      
      if (msg.type === 'collections-loaded') {
        collections = msg.collections;
        collectionSelect.innerHTML = '';
        
        if (collections.length === 0) {
          collectionSelect.innerHTML = '<option value="">No collections found</option>';
          collectionSelect.disabled = true;
        } else {
          collectionSelect.innerHTML = '<option value="">Select collection...</option>';
          collections.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = `${c.name} (${c.modes.length} modes)`;
            collectionSelect.appendChild(opt);
          });
          collectionSelect.disabled = false;
        }
      }
      
      if (msg.type === 'stylesheet-generated') {
        currentStylesheet = msg.stylesheet;
        currentModeName = msg.modeName;
        
        codeFilename.textContent = `${currentModeName.toLowerCase().replace(/\s+/g, '-')}-theme.css`;
        codeContent.innerHTML = highlightCSS(currentStylesheet);
        updatePreview(currentStylesheet);
        
        emptyState.style.display = 'none';
        outputSection.style.display = 'block';
      }
    };
  </script>
</body>
</html>
