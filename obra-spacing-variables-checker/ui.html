<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 12px;
            background: #ffffff;
            color: #333333;
            font-size: 11px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }
        
        .header {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e5e5e5;
        }
        
        .title {
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 8px 0;
        }
        
        .subtitle {
            color: #666;
            font-size: 12px;
            margin: 0;
        }
        
        .section {
            margin-bottom: 12px;
            flex-shrink: 0;
        }
        
        .button {
            background: #18a0fb;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            width: 100%;
            margin-bottom: 8px;
        }
        
        .button:hover {
            background: #0d8ce8;
        }
        
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .button-small {
            padding: 4px 8px;
            font-size: 11px;
            width: auto;
            margin: 0;
        }
        
        .button-success {
            background: #28a745;
        }
        
        .button-success:hover {
            background: #218838;
        }
        
        .error-banner {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 12px;
            display: flex;
            align-items: center;
        }
        
        .error-icon {
            margin-right: 8px;
            font-weight: bold;
        }
        
        .status {
            background: #f7f7f7;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 10px;
            color: #8c8c8c;
        }
        
        .accordion {
            border: none;
            border-radius: 0;
            margin-bottom: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .accordion-header {
            background: transparent;
            padding: 8px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
            font-size: 11px;
            border-bottom: 1px solid #e1e1e1;
            transition: background-color 0.15s;
        }
        
        .accordion-header:hover {
            background: #f7f7f7;
        }
        
        .accordion-header.has-problems {
            background: transparent;
        }
        
        .accordion-header.has-problems:hover {
            background: #f7f7f7;
        }
        
        .accordion-toggle {
            font-size: 12px;
            color: #666;
            transition: transform 0.2s;
            flex-shrink: 0;
            width: 12px;
            text-align: center;
        }
        
        .accordion-toggle.open {
            transform: rotate(90deg);
        }
        
        .accordion-title {
            flex-grow: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .accordion-content {
            display: none;
            padding: 12px 0 16px 0;
        }
        
        .accordion-content.open {
            display: block;
        }
        
        .problem-count {
            background: #dc3545;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
        }
        
        .success-count {
            background: #28a745;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
        }
        
        .variables-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 4px;
            font-size: 11px;
            line-height: 1.4;
            max-width: 100%;
        }
        
        .variable-tag {
            background: #ffffff;
            color: #1e293b;
            border: 1px solid #e2e8f0;
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            text-align: center;
            overflow: visible;
            word-break: keep-all;
        }
        
        .ignore-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e5e5e5;
        }
        
        .ignore-input-container {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .ignore-input {
            flex-grow: 1;
            padding: 6px 8px;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .ignore-add-btn {
            padding: 6px 12px;
            font-size: 10px;
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            cursor: pointer;
            color: #475569;
        }
        
        .ignore-add-btn:hover {
            background: #e2e8f0;
            border-color: #94a3b8;
        }
        
        .ignore-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }
        
        .ignore-tag {
            background: #e2e8f0;
            color: #475569;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .ignore-remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            color: #64748b;
        }
        
        .ignore-remove:hover {
            color: #1e293b;
        }
        
        .layers-list {
            max-height: calc(100vh - 250px);
            overflow-y: auto;
            border: none;
            border-radius: 0;
            margin-bottom: 12px;
            min-height: 200px;
        }
        
        .layer-item {
            padding: 8px 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.15s;
        }
        
        .layer-item:hover {
            background: #f7f7f7;
        }
        
        .layer-item:last-child {
            border-bottom: none;
        }
        
        .layer-item.selected {
            background: #e3f2fd;
            border-left: 3px solid #0066ff;
        }
        
        .layer-item.is-component {
            background: #faf5ff;
        }
        
        .layer-item.is-component:hover {
            background: #f3e8ff;
        }
        
        .layer-item.is-component.selected {
            background: #ede9f1;
            border-left-color: #9333ea;
        }
        
        .component-indicator {
            color: #9333ea;
            font-size: 12px;
            margin-right: 4px;
        }
        
        .component-recommendation {
            background: #f3e8ff;
            border: 1px solid #c084fc;
            color: #7c3aed;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 12px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        
        .component-recommendation-icon {
            color: #9333ea;
            font-size: 14px;
            flex-shrink: 0;
            margin-top: 1px;
        }
        
        .autofix-section {
            background: #f0f9ff;
            border: 1px solid #38bdf8;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 16px;
            text-align: center;
        }
        
        .autofix-button {
            background: #0ea5e9;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
            transition: background-color 0.2s;
        }
        
        .autofix-button:hover {
            background: #0284c7;
        }
        
        .autofix-button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        
        .autofix-icon {
            font-size: 14px;
        }
        
        .autofix-description {
            color: #0369a1;
            font-size: 11px;
            margin: 0;
        }
        
        .layer-name {
            font-weight: 500;
            font-size: 11px;
            margin-bottom: 3px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .layer-radius {
            font-size: 10px;
            color: #18a0fb;
            background: #e8f4fd;
            padding: 2px 4px;
            border-radius: 4px;
        }
        
        .layer-details {
            font-size: 10px;
            color: #8c8c8c;
            margin-bottom: 4px;
        }
        
        .layer-suggestion {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            gap: 8px;
        }
        
        .suggestion-text {
            font-size: 11px;
            color: #333;
            flex-grow: 1;
        }
        
        .suggestion-button {
            padding: 4px 8px;
            font-size: 10px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .suggestion-button:hover {
            background: #218838;
        }
        
        .apply-options {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            min-width: 120px;
            font-size: 10px;
        }
        
        .apply-option {
            padding: 6px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .apply-option:hover {
            background: #f5f5f5;
        }
        
        .apply-option:last-child {
            border-bottom: none;
        }
        
        .suggestion-button-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-arrow {
            margin-left: 2px;
            font-size: 8px;
        }
        
        .issue-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 8px;
        }
        
        .issue-missing {
            background: #fff3cd;
            color: #856404;
        }
        
        .issue-no-match {
            background: #f8d7da;
            color: #721c24;
        }
        
        .issue-fixed {
            background: #d4edda;
            color: #155724;
        }
        
        .selected-layer-info {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
        }
        
        .selected-layer-name {
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .hidden {
            display: none;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #e1e1e1;
            margin: -12px -12px 12px -12px;
            padding: 0;
            background: #ffffff;
            flex-shrink: 0;
        }
        
        .tab {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 400;
            color: #8c8c8c;
            background: transparent;
            border: none;
            border-bottom: 1px solid transparent;
            transition: all 0.15s ease;
            position: relative;
            line-height: 1.2;
        }
        
        .tab:hover {
            color: #333333;
            background: #f7f7f7;
        }
        
        .tab.active {
            color: #333333;
            font-weight: 500;
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: #18a0fb;
        }
        
        .tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }
        
        .tab-content.active {
            display: flex;
            flex-direction: column;
        }
        
        #layersTab {
            overflow-y: auto;
        }
        
        .plugin-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0;
        }
    </style>
</head>
<body>
    <div class="plugin-container">
    <div class="tabs">
        <button class="tab active" onclick="switchTab('layers')">Layers</button>
        <button class="tab" onclick="switchTab('settings')">Settings</button>
    </div>

    <div id="errorBanner" class="error-banner hidden">
        <span class="error-icon">⚠</span>
        <span id="errorMessage"></span>
    </div>

    <!-- Layers Tab -->
    <div id="layersTab" class="tab-content active">
        <div id="scanSection" class="section">
            <button id="scanBtn" class="button">Scan Selected Layers</button>
            <div id="status" class="status hidden">Ready to scan...</div>
        </div>

        <div id="layersAccordion" class="accordion hidden">
            <div class="accordion-header" id="layersHeader" onclick="toggleAccordion('layers')">
                <span class="accordion-toggle open" id="layersToggle">▶</span>
                <span class="accordion-title">
                    <span id="layersTitle">Layers with Problems</span>
                    <span id="problemsCount" class="problem-count hidden"></span>
                </span>
            </div>
            <div class="accordion-content open" id="layersContent">
                <div id="layersList" class="layers-list"></div>
            </div>
        </div>

        <div id="fixedLayersAccordion" class="accordion hidden">
            <div class="accordion-header" onclick="toggleAccordion('fixed')">
                <span class="accordion-toggle" id="fixedToggle">▶</span>
                <span class="accordion-title">
                    <span>Layers Already Fixed</span>
                    <span id="fixedCount" class="success-count hidden"></span>
                </span>
            </div>
            <div class="accordion-content" id="fixedContent">
                <div id="fixedLayersList" class="layers-list"></div>
            </div>
        </div>

        <div id="selectedLayerAccordion" class="accordion hidden">
            <div class="accordion-header" onclick="toggleAccordion('selected')">
                <span class="accordion-toggle open" id="selectedToggle">▶</span>
                <span id="selectedLayerTitle" class="accordion-title">Selected Layer</span>
            </div>
            <div class="accordion-content open" id="selectedContent">
                <div id="selectedLayerInfo" class="selected-layer-info">
                    <div id="selectedLayerName" class="selected-layer-name"></div>
                    <div id="selectedLayerDetails" style="font-size: 11px; color: #666; margin-bottom: 8px;"></div>
                    <div id="selectedLayerSuggestion"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Tab -->
    <div id="settingsTab" class="tab-content">
        <div class="accordion">
            <div class="accordion-header" onclick="toggleAccordion('variables')">
                <span class="accordion-toggle open" id="variablesToggle">▶</span>
                <span class="accordion-title">Available Variables</span>
            </div>
            <div class="accordion-content open" id="variablesContent">
                <div id="variablesList" class="variables-list">
                    <div style="color: #999; font-style: italic;">Loading...</div>
                </div>
            </div>
        </div>

        <div class="accordion">
            <div class="accordion-header" onclick="toggleAccordion('ignored')">
                <span class="accordion-toggle open" id="ignoredToggle">▶</span>
                <span class="accordion-title">Ignored Layer Names</span>
            </div>
            <div class="accordion-content open" id="ignoredContent">
                <div style="font-size: 11px; color: #666; margin-bottom: 12px;">Layers with these exact names will be skipped during scanning:</div>
                <div class="ignore-input-container">
                    <input type="text" id="ignoreInput" class="ignore-input" placeholder="Enter exact layer name to ignore">
                    <button id="addIgnoreBtn" class="ignore-add-btn">Add</button>
                </div>
                <div id="ignoreList" class="ignore-list"></div>
            </div>
        </div>
    </div>

    <script>
        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            initializePlugin();
        });

        // If DOMContentLoaded already fired, initialize immediately
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePlugin);
        } else {
            initializePlugin();
        }

        function initializePlugin() {
            var elements = {
                scanBtn: document.getElementById('scanBtn'),
                status: document.getElementById('status'),
                errorBanner: document.getElementById('errorBanner'),
                errorMessage: document.getElementById('errorMessage'),
                variablesList: document.getElementById('variablesList'),
                ignoreInput: document.getElementById('ignoreInput'),
                addIgnoreBtn: document.getElementById('addIgnoreBtn'),
                ignoreList: document.getElementById('ignoreList'),
                layersAccordion: document.getElementById('layersAccordion'),
                layersHeader: document.getElementById('layersHeader'),
                layersTitle: document.getElementById('layersTitle'),
                problemsCount: document.getElementById('problemsCount'),
                layersList: document.getElementById('layersList'),
                fixedLayersAccordion: document.getElementById('fixedLayersAccordion'),
                fixedCount: document.getElementById('fixedCount'),
                fixedLayersList: document.getElementById('fixedLayersList'),
                selectedLayerAccordion: document.getElementById('selectedLayerAccordion'),
                selectedLayerTitle: document.getElementById('selectedLayerTitle'),
                selectedLayerName: document.getElementById('selectedLayerName'),
                selectedLayerDetails: document.getElementById('selectedLayerDetails'),
                selectedLayerSuggestion: document.getElementById('selectedLayerSuggestion')
            };

            var variables = [];
            var layers = [];
            var problemLayers = [];
            var fixedLayers = [];
            var selectedLayer = null;
            var ignoredLayerNames = [];

            // Check all elements exist before adding event listeners
            if (!elements.scanBtn || !elements.addIgnoreBtn || !elements.ignoreInput) {
                console.error('Required DOM elements not found');
                return;
            }

            // Event listeners
            elements.scanBtn.addEventListener('click', function() {
                hideError();
                parent.postMessage({ pluginMessage: { type: 'start-scan', ignoredNames: ignoredLayerNames } }, '*');
            });

            elements.addIgnoreBtn.addEventListener('click', addIgnoreItem);
            
            elements.ignoreInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addIgnoreItem();
                }
            });

            // Request ignored names from plugin on startup
            parent.postMessage({ pluginMessage: { type: 'load-ignored-names' } }, '*');

            // Save ignored names via plugin clientStorage
            function saveIgnoredNames() {
                parent.postMessage({ 
                    pluginMessage: { 
                        type: 'save-ignored-names',
                        ignoredNames: ignoredLayerNames
                    } 
                }, '*');
                console.log('Requested save of ignored names:', ignoredLayerNames);
            }


            // Show error banner
            function showError(message) {
                if (elements.errorMessage && elements.errorBanner) {
                    elements.errorMessage.textContent = message;
                    elements.errorBanner.classList.remove('hidden');
                }
            }

            // Hide error banner
            function hideError() {
                if (elements.errorBanner) {
                    elements.errorBanner.classList.add('hidden');
                }
            }

            // Ignore list management
            function addIgnoreItem() {
                var name = elements.ignoreInput.value.trim();
                if (name && ignoredLayerNames.indexOf(name) === -1) {
                    ignoredLayerNames.push(name);
                    elements.ignoreInput.value = '';
                    updateIgnoreList();
                    saveIgnoredNames();
                }
            }

            function removeIgnoreItem(name) {
                var index = ignoredLayerNames.indexOf(name);
                if (index !== -1) {
                    ignoredLayerNames.splice(index, 1);
                    updateIgnoreList();
                    saveIgnoredNames();
                }
            }

            function updateIgnoreList() {
                if (!elements.ignoreList) return;

                if (ignoredLayerNames.length === 0) {
                    elements.ignoreList.innerHTML = '<div style="color: #999; font-size: 10px; font-style: italic;">No ignored layer names</div>';
                    return;
                }

                var html = '';
                for (var i = 0; i < ignoredLayerNames.length; i++) {
                    var name = ignoredLayerNames[i];
                    html += '<div class="ignore-tag">' +
                           '<span>' + name + '</span>' +
                           '<span class="ignore-remove" onclick="window.removeIgnoreItem(\'' + name + '\')">&times;</span>' +
                           '</div>';
                }
                elements.ignoreList.innerHTML = html;
            }

            // Make removeIgnoreItem available globally
            window.removeIgnoreItem = removeIgnoreItem;

            // Toggle accordion sections
            function toggleAccordion(section) {
                var content = document.getElementById(section + 'Content');
                var toggle = document.getElementById(section + 'Toggle');
                
                if (content && toggle) {
                    if (content.classList.contains('open')) {
                        content.classList.remove('open');
                        toggle.classList.remove('open');
                    } else {
                        content.classList.add('open');
                        toggle.classList.add('open');
                    }
                }
            }

            // Make toggleAccordion available globally
            window.toggleAccordion = toggleAccordion;

            // Tab switching function
            function switchTab(tabName) {
                // Remove active class from all tabs
                var tabs = document.querySelectorAll('.tab');
                for (var i = 0; i < tabs.length; i++) {
                    tabs[i].classList.remove('active');
                }
                
                // Remove active class from all tab contents
                var contents = document.querySelectorAll('.tab-content');
                for (var j = 0; j < contents.length; j++) {
                    contents[j].classList.remove('active');
                }
                
                // Add active class to clicked tab and its content
                event.target.classList.add('active');
                document.getElementById(tabName + 'Tab').classList.add('active');
            }

            // Make switchTab available globally
            window.switchTab = switchTab;

            // Update variables list
            function updateVariablesList(variableData) {
                if (!elements.variablesList) return;

                variables = variableData.variables || [];
                
                if (variableData.error) {
                    elements.variablesList.innerHTML = '<div style="color: #ff0000;">Error: ' + variableData.error + '</div>';
                    return;
                }
                
                if (variables.length === 0) {
                    elements.variablesList.innerHTML = '<div style="color: #999; font-style: italic;">No spacing variables found</div>';
                    return;
                }

                var html = '';
                for (var i = 0; i < variables.length; i++) {
                    var variable = variables[i];
                    html += '<div class="variable-tag">' + variable.name + ' = ' + variable.value + 'px</div>';
                }
                
                elements.variablesList.innerHTML = html;
            }

            // Update layers list with separation
            function updateLayersList(layersData) {
                layers = layersData;
                
                // Sort function to prioritize components over instances
                function sortLayersByPriority(a, b) {
                    // Components first, then instances, then other types
                    var priorityA = a.type === 'COMPONENT' ? 0 : (a.type === 'INSTANCE' ? 1 : 2);
                    var priorityB = b.type === 'COMPONENT' ? 0 : (b.type === 'INSTANCE' ? 1 : 2);
                    
                    if (priorityA !== priorityB) {
                        return priorityA - priorityB;
                    }
                    
                    // If same priority, sort by name
                    return a.name.localeCompare(b.name);
                }
                
                // Separate layers by problem type and sort each group
                problemLayers = [];
                fixedLayers = [];
                
                for (var i = 0; i < layers.length; i++) {
                    if (layers[i].issueType === 'has_variable') {
                        fixedLayers.push(layers[i]);
                    } else {
                        problemLayers.push(layers[i]);
                    }
                }
                
                // Sort both groups by priority
                problemLayers.sort(sortLayersByPriority);
                fixedLayers.sort(sortLayersByPriority);
                
                // Update problem layers accordion
                if (problemLayers.length > 0 && elements.layersAccordion && elements.problemsCount) {
                    elements.problemsCount.textContent = problemLayers.length;
                    elements.problemsCount.classList.remove('hidden');
                    elements.layersHeader.classList.add('has-problems');
                    elements.layersAccordion.classList.remove('hidden');
                    
                    var problemHtml = '';
                    
                    // Check if we have instances with problems
                    var hasInstances = problemLayers.some(function(layer) { 
                        return layer.type === 'INSTANCE' && layer.issueType === 'missing_variable'; 
                    });
                    
                    // Add recommendation banner if instances need fixing
                    if (hasInstances) {
                        problemHtml += '<div class="component-recommendation">' +
                                     '<span class="component-recommendation-icon">❖</span>' +
                                     '<div><strong>Tip:</strong> Fix spacing variables in components (❖) rather than instances (◇). ' +
                                     'Changes to components automatically apply to all their instances.</div>' +
                                     '</div>';
                    }
                    
                    // Add autofix button if there are layers that can be fixed
                    var fixableLayers = problemLayers.filter(function(layer) {
                        return layer.issueType === 'missing_variable' && layer.suggestion && layer.suggestion.type === 'apply_variable';
                    });
                    
                    if (fixableLayers.length > 0) {
                        problemHtml += '<div class="autofix-section">' +
                                     '<button class="button button-primary autofix-button" onclick="window.autofixAll()">' +
                                     '<span class="autofix-icon">⚡</span> Fix All (' + fixableLayers.length + ')' +
                                     '</button>' +
                                     '<div class="autofix-description">Apply all suggested spacing variables automatically</div>' +
                                     '</div>';
                    }
                    
                    for (var j = 0; j < problemLayers.length; j++) {
                        problemHtml += createLayerItemHtml(problemLayers[j]);
                    }
                    elements.layersList.innerHTML = problemHtml;
                    addLayerClickHandlers(elements.layersList);
                } else if (elements.layersAccordion) {
                    elements.layersAccordion.classList.add('hidden');
                }
                
                // Update fixed layers accordion
                if (fixedLayers.length > 0 && elements.fixedLayersAccordion && elements.fixedCount) {
                    elements.fixedCount.textContent = fixedLayers.length;
                    elements.fixedCount.classList.remove('hidden');
                    elements.fixedLayersAccordion.classList.remove('hidden');
                    
                    var fixedHtml = '';
                    for (var k = 0; k < fixedLayers.length; k++) {
                        fixedHtml += createLayerItemHtml(fixedLayers[k]);
                    }
                    elements.fixedLayersList.innerHTML = fixedHtml;
                    addLayerClickHandlers(elements.fixedLayersList);
                } else if (elements.fixedLayersAccordion) {
                    elements.fixedLayersAccordion.classList.add('hidden');
                }
                
                // Show message if no layers found
                if (layers.length === 0 && elements.layersList && elements.layersAccordion) {
                    elements.layersList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No layers with spacing properties found</div>';
                    elements.layersAccordion.classList.remove('hidden');
                    elements.layersHeader.classList.remove('has-problems');
                }
            }

            // Create HTML for a layer item
            function createLayerItemHtml(layer) {
                var issueClass = 'issue-missing';
                var issueBadge = 'Missing Variable';
                var suggestionButton = '';
                
                if (layer.issueType === 'has_variable') {
                    issueClass = 'issue-fixed';
                    issueBadge = 'Has Variable';
                } else if (layer.issueType === 'no_matching_variable') {
                    issueClass = 'issue-no-match';
                    issueBadge = 'No Match';
                } else if (layer.issueType === 'missing_variable' && layer.suggestion.type === 'apply_variable') {
                    // Create dropdown ID
                    var dropdownId = 'dropdown-' + layer.id;
                    
                    // For instances, show both tip and apply button
                    if (layer.type === 'INSTANCE') {
                        suggestionButton = '<div>' +
                                         '<span style="font-size: 10px; color: #7c3aed; font-style: italic; display: block; margin-bottom: 4px;">Tip: Fix in component instead</span>' +
                                         '<button class="suggestion-button" onclick="window.applyVariable(\'' + 
                                         layer.id + '\', \'' + layer.suggestion.variable.id + '\', null, \'' + 
                                         (layer.suggestion.property || layer.spacingProperty) + '\')">Apply</button>' +
                                         '</div>';
                    } else {
                        // For spacing, apply directly to the detected property
                        suggestionButton = '<button class="suggestion-button" onclick="window.applyVariable(\'' + 
                                         layer.id + '\', \'' + layer.suggestion.variable.id + '\', null, \'' + 
                                         (layer.suggestion.property || layer.spacingProperty) + '\')">Apply</button>';
                    }
                }
                
                // Check if it's a component/instance and add appropriate styling
                var isComponent = layer.type === 'COMPONENT' || layer.type === 'INSTANCE';
                var componentClass = isComponent ? ' is-component' : '';
                var componentIndicator = '';
                
                if (layer.type === 'COMPONENT') {
                    componentIndicator = '<span class="component-indicator">\u2756</span>'; // ❖ for components
                } else if (layer.type === 'INSTANCE') {
                    componentIndicator = '<span class="component-indicator">\u25c7</span>'; // ◇ for instances
                }
                
                return '<div class="layer-item' + componentClass + '" data-layer-id="' + layer.id + '">' +
                       '<div class="layer-name">' +
                       '<span>' + componentIndicator + layer.name + '</span>' +
                       '<span class="layer-radius">' + (layer.spacingValue || layer.radiusValue) + 'px</span>' +
                       '</div>' +
                       '<div class="layer-details">' + layer.type + '</div>' +
                       '<div class="layer-suggestion">' +
                       '<span class="suggestion-text">' + layer.suggestion.message + '</span>' +
                       '<div style="display: flex; gap: 4px; align-items: center;">' +
                       suggestionButton +
                       '<span class="issue-badge ' + issueClass + '">' + issueBadge + '</span>' +
                       '</div>' +
                       '</div>' +
                       '</div>';
            }

            // Add click handlers to layer items
            function addLayerClickHandlers(container) {
                if (!container) return;
                var items = container.querySelectorAll('.layer-item');
                for (var i = 0; i < items.length; i++) {
                    (function(item) {
                        item.addEventListener('click', function() {
                            var layerId = this.getAttribute('data-layer-id');
                            selectLayer(layerId);
                        });
                    })(items[i]);
                }
            }

            // Select a layer
            function selectLayer(layerId) {
                // Remove previous selection from both lists
                var prevSelected = document.querySelector('.layer-item.selected');
                if (prevSelected) {
                    prevSelected.classList.remove('selected');
                }

                // Add selection to clicked item
                var newSelected = document.querySelector('[data-layer-id="' + layerId + '"]');
                if (newSelected) {
                    newSelected.classList.add('selected');
                }

                // Navigate to layer in Figma
                parent.postMessage({ 
                    pluginMessage: { 
                        type: 'navigate-to-layer', 
                        layerId: layerId 
                    } 
                }, '*');
            }

            // Update selected layer info
            function updateSelectedLayerInfo(layer) {
                selectedLayer = layer;
                
                if (elements.selectedLayerTitle && elements.selectedLayerName && elements.selectedLayerDetails) {
                    elements.selectedLayerTitle.textContent = 'Selected: ' + layer.name;
                    elements.selectedLayerName.textContent = layer.name;
                    elements.selectedLayerDetails.textContent = layer.type + ' • ' + (layer.spacingValue || layer.radiusValue) + 'px ' + (layer.spacingProperty || 'spacing');
                    
                    var suggestionHtml = '';
                    if (layer.suggestion.type === 'apply_variable') {
                        suggestionHtml = '<div style="margin-bottom: 8px;">' + layer.suggestion.message + '</div>' +
                                       '<button class="button button-success button-small" onclick="window.applyVariable(\'' + 
                                       layer.id + '\', \'' + layer.suggestion.variable.id + '\', null, \'' + 
                                       (layer.suggestion.property || layer.spacingProperty) + '\')">Apply Variable</button>';
                    } else {
                        suggestionHtml = '<div style="color: #666; font-size: 11px;">' + layer.suggestion.message + '</div>';
                    }
                    
                    elements.selectedLayerSuggestion.innerHTML = suggestionHtml;
                    elements.selectedLayerAccordion.classList.remove('hidden');
                }
            }

            // Apply variable to layer
            function applyVariable(layerId, variableId, applyMode, propertyName) {
                // Hide any open dropdowns
                var dropdowns = document.querySelectorAll('.apply-options');
                for (var i = 0; i < dropdowns.length; i++) {
                    dropdowns[i].style.display = 'none';
                }
                
                parent.postMessage({ 
                    pluginMessage: { 
                        type: 'apply-variable', 
                        layerId: layerId,
                        variableId: variableId,
                        applyMode: applyMode,
                        propertyName: propertyName
                    } 
                }, '*');
            }

            // Toggle apply dropdown
            function toggleApplyDropdown(dropdownId) {
                var dropdown = document.getElementById(dropdownId);
                if (dropdown) {
                    // Hide all other dropdowns first
                    var allDropdowns = document.querySelectorAll('.apply-options');
                    for (var i = 0; i < allDropdowns.length; i++) {
                        if (allDropdowns[i].id !== dropdownId) {
                            allDropdowns[i].style.display = 'none';
                        }
                    }
                    
                    // Toggle this dropdown
                    if (dropdown.style.display === 'block') {
                        dropdown.style.display = 'none';
                    } else {
                        dropdown.style.display = 'block';
                        
                        // Position dropdown relative to button
                        var rect = dropdown.parentElement.getBoundingClientRect();
                        dropdown.style.top = '100%';
                        dropdown.style.right = '0';
                    }
                }
            }

            // Hide dropdowns when clicking elsewhere
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.suggestion-button-dropdown')) {
                    var dropdowns = document.querySelectorAll('.apply-options');
                    for (var i = 0; i < dropdowns.length; i++) {
                        dropdowns[i].style.display = 'none';
                    }
                }
            });

            // Make functions available globally
            window.toggleApplyDropdown = toggleApplyDropdown;

            // Make applyVariable available globally
            window.applyVariable = applyVariable;
            
            // Autofix all function
            function autofixAll() {
                var button = document.querySelector('.autofix-button');
                if (button) {
                    button.disabled = true;
                    button.innerHTML = '<span class="autofix-icon">⏳</span> Applying...';
                }
                
                parent.postMessage({
                    pluginMessage: {
                        type: 'autofix_all'
                    }
                }, '*');
            }
            
            // Make autofixAll available globally
            window.autofixAll = autofixAll;

            // Handle messages from plugin
            window.addEventListener('message', function(event) {
                var msg = event.data.pluginMessage;
                if (!msg) return;

                console.log('UI received message:', msg.type);

                switch (msg.type) {
                    case 'variables-found':
                        updateVariablesList(msg);
                        break;
                    
                    case 'scan-started':
                        hideError();
                        if (elements.status) {
                            elements.status.textContent = 'Scanning selected layers...';
                            elements.status.classList.remove('hidden');
                        }
                        if (elements.scanBtn) {
                            elements.scanBtn.disabled = true;
                        }
                        break;
                    
                    case 'scan-complete':
                        if (elements.status && elements.scanBtn) {
                            elements.status.textContent = 'Found ' + msg.totalLayers + ' layers with spacing properties';
                            elements.scanBtn.disabled = false;
                        }
                        updateLayersList(msg.layers);
                        break;
                    
                    case 'layer-selected':
                        updateSelectedLayerInfo(msg.layer);
                        break;
                    
                    case 'variable-applied':
                        hideError();
                        if (elements.status) {
                            elements.status.textContent = 'Applied "' + msg.variableName + '" to "' + msg.layerName + '"';
                            elements.status.classList.remove('hidden');
                        }
                        
                        // Update the layer in our lists
                        for (var i = 0; i < layers.length; i++) {
                            if (layers[i].id === msg.layerId) {
                                layers[i].hasVariable = true;
                                layers[i].issueType = 'has_variable';
                                layers[i].suggestion = {
                                    type: 'already_fixed',
                                    message: 'Already using variable'
                                };
                                break;
                            }
                        }
                        
                        // Update problem and fixed arrays
                        for (var j = 0; j < problemLayers.length; j++) {
                            if (problemLayers[j].id === msg.layerId) {
                                problemLayers[j].hasVariable = true;
                                problemLayers[j].issueType = 'has_variable';
                                problemLayers[j].suggestion = {
                                    type: 'already_fixed',
                                    message: 'Already using variable'
                                };
                                break;
                            }
                        }
                        
                        // Refresh the layers list to move item to fixed section and remove apply button
                        updateLayersList(layers);
                        
                        // Update selected layer info if it's the same layer
                        if (selectedLayer && selectedLayer.id === msg.layerId) {
                            selectedLayer.hasVariable = true;
                            selectedLayer.issueType = 'has_variable';
                            selectedLayer.suggestion = {
                                type: 'already_fixed',
                                message: 'Already using variable'
                            };
                            updateSelectedLayerInfo(selectedLayer);
                        }
                        break;
                    
                    case 'autofix-complete':
                        var button = document.querySelector('.autofix-button');
                        if (button) {
                            button.disabled = false;
                            button.innerHTML = '<span class="autofix-icon">⚡</span> Fix All (' + 
                                             (button.innerHTML.match(/\((\d+)\)/) ? button.innerHTML.match(/\((\d+)\)/)[1] : '0') + ')';
                        }
                        
                        hideError();
                        if (elements.status) {
                            var statusText = 'Autofix complete: ' + msg.totalFixed + ' fixed';
                            if (msg.totalFailed > 0) {
                                statusText += ', ' + msg.totalFailed + ' failed';
                            }
                            elements.status.textContent = statusText;
                            elements.status.classList.remove('hidden');
                        }
                        
                        // Show detailed results if there were failures
                        if (msg.totalFailed > 0) {
                            var failureDetails = 'Failed layers:\n' + 
                                               msg.failedLayers.map(function(fail) {
                                                   return '• ' + fail.layerName + ': ' + fail.reason;
                                               }).join('\n');
                            console.warn('Autofix failures:', failureDetails);
                        }
                        break;
                    
                    case 'error':
                        showError(msg.message);
                        if (elements.scanBtn) {
                            elements.scanBtn.disabled = false;
                        }
                        break;
                    
                    case 'ignored-names-loaded':
                        ignoredLayerNames = msg.ignoredNames || ['Labels', 'Label', 'Bracket', 'Instances', 'Instance'];
                        console.log('Loaded ignored names from plugin:', ignoredLayerNames);
                        updateIgnoreList();
                        break;
                }
            });
        }
    </script>
    </div>
</body>
</html>